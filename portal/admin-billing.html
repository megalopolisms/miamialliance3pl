<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Activity Billing | Miami Alliance 3PL</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“¦</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css?v=8">
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KTW0F25ZM1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-KTW0F25ZM1');
    </script>
    <script src="../js/analytics.js"></script>
    <style>
        .page-header-bar {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            color: white;
            padding: var(--spacing-xl);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-xl);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .page-header-bar p { opacity: 0.9; }

        /* Stats Row */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }
        .stat-card {
            background: white;
            border: 1px solid var(--color-gray-200);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            text-align: center;
        }
        .stat-card .value {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: var(--color-primary);
        }
        .stat-card .label {
            color: var(--color-gray-500);
            font-size: var(--font-size-sm);
        }
        .stat-card.warning .value { color: #f59e0b; }
        .stat-card.success .value { color: #10b981; }
        .stat-card.info .value { color: #3b82f6; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            border-bottom: 2px solid var(--color-gray-200);
            padding-bottom: var(--spacing-sm);
        }
        .tab {
            padding: 8px 16px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 500;
            color: var(--color-gray-500);
            border-bottom: 2px solid transparent;
            margin-bottom: -calc(var(--spacing-sm) + 2px);
            font-size: var(--font-size-sm);
        }
        .tab.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        /* Cards */
        .section-card {
            background: white;
            border: 1px solid var(--color-gray-200);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }
        .section-card h3 {
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Form */
        .entry-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
        }
        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--color-gray-700);
            font-size: var(--font-size-sm);
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--color-gray-300);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
        }
        .form-group select { cursor: pointer; }
        .form-group input:focus,
        .form-group select:focus {
            border-color: var(--color-primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(30, 58, 95, 0.1);
        }

        /* Rate auto-fill indicator */
        .rate-hint {
            font-size: 0.7rem;
            color: var(--color-gray-400);
            margin-top: 2px;
        }

        /* Calculated preview */
        .calc-preview {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-top: var(--spacing-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .calc-preview .amount {
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: var(--color-primary);
        }

        /* Button rows */
        .btn-row {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }

        /* Activity table */
        .activity-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        .activity-table th, .activity-table td {
            padding: var(--spacing-sm) var(--spacing-md);
            text-align: left;
            border-bottom: 1px solid var(--color-gray-200);
            font-size: var(--font-size-sm);
        }
        .activity-table th {
            background: var(--color-gray-50);
            font-weight: 600;
        }
        .activity-table tr:hover {
            background: var(--color-gray-50);
        }

        /* Badge */
        .badge {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .badge-unbilled { background: #fef3c7; color: #d97706; }
        .badge-billed { background: #d1fae5; color: #059669; }

        /* Filters bar */
        .filters-bar {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
            align-items: center;
        }
        .filters-bar select, .filters-bar input {
            padding: 8px 12px;
            border: 1px solid var(--color-gray-300);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
        }

        /* Reconciliation */
        .reconciliation-card {
            background: white;
            border: 1px solid var(--color-gray-200);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
        }
        .recon-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) 0;
            border-bottom: 1px solid var(--color-gray-100);
            align-items: center;
        }
        .recon-row.header {
            font-weight: 600;
            background: var(--color-gray-50);
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
        }
        .recon-row .variance-positive { color: #ef4444; font-weight: 600; }
        .recon-row .variance-negative { color: #10b981; font-weight: 600; }
        .recon-row .variance-zero { color: var(--color-gray-500); }
        .recon-total {
            display: flex;
            justify-content: space-between;
            padding: var(--spacing-md) 0;
            margin-top: var(--spacing-sm);
            border-top: 2px solid var(--color-gray-800);
            font-weight: 700;
            font-size: var(--font-size-lg);
        }

        /* Quick entry badges */
        .quick-types {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: var(--spacing-md);
        }
        .quick-type {
            padding: 6px 14px;
            border: 1px solid var(--color-gray-300);
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        .quick-type:hover, .quick-type.selected {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 500;
            z-index: 9999;
            display: none;
        }
        .toast.show { display: block; animation: slideIn 0.3s ease; }
        .toast.success { background: #10b981; }
        .toast.error { background: #ef4444; }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Delete button */
        .btn-delete {
            background: #fee2e2;
            color: #dc2626;
            border: none;
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.75rem;
        }
        .btn-delete:hover { background: #fecaca; }

        /* Generate Invoice CTA */
        .generate-invoice-bar {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--spacing-lg);
        }
        .generate-invoice-bar .info h3 { margin: 0; font-size: var(--font-size-lg); }
        .generate-invoice-bar .info p { margin: 4px 0 0; opacity: 0.9; font-size: var(--font-size-sm); }
        .btn-generate {
            background: white;
            color: #059669;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius-md);
            font-weight: 700;
            cursor: pointer;
            font-size: var(--font-size-sm);
        }
        .btn-generate:hover { background: #f0fdf4; }

        @media (max-width: 768px) {
            .entry-form { grid-template-columns: 1fr; }
            .recon-row { grid-template-columns: 1fr 1fr; }
            .filters-bar { flex-direction: column; }
            .generate-invoice-bar { flex-direction: column; gap: var(--spacing-md); text-align: center; }
        }
    </style>
</head>
<body>
    <header class="header">
        <nav class="nav container">
            <a href="../index.html" class="logo">
                <span class="logo-text">MIAMI ALLIANCE <span class="logo-accent">3PL</span></span>
            </a>
            <ul class="nav-menu">
                <li><span id="user-name" class="nav-link">Welcome</span></li>
                <li><a href="#" id="logout-btn" class="nav-link btn btn-outline">Logout</a></li>
            </ul>
        </nav>
    </header>

    <div class="portal-layout">
        <aside class="portal-sidebar">
            <nav>
                <a href="dashboard.html" class="portal-nav-item"><span>ğŸ“Š</span> <span>Dashboard</span></a>
                <a href="shipments.html" class="portal-nav-item"><span>ğŸšš</span> <span>Shipments</span></a>
                <a href="pickups.html" class="portal-nav-item">
                    <span aria-hidden="true">ğŸ—ï¸</span> <span>Pickup & Delivery</span>
                </a>
                <a href="tracking.html" class="portal-nav-item"><span>ğŸ”</span> <span>Tracking</span></a>
                <a href="inventory.html" class="portal-nav-item"><span>ğŸ“¦</span> <span>Inventory</span></a>
                <a href="billing.html" class="portal-nav-item"><span>ğŸ’µ</span> <span>Billing</span></a>
                <a href="contracts.html" class="portal-nav-item"><span>ğŸ“„</span> <span>Contracts</span></a>
                <div id="employee-nav" style="display: none; margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--color-gray-200);">
                    <div style="padding: 8px 16px; font-size: 0.75rem; color: var(--color-gray-500); text-transform: uppercase;">Staff</div>
                    <a href="customers.html" class="portal-nav-item"><span>ğŸ‘¥</span> <span>All Customers</span></a>
                    <a href="admin-shipments.html" class="portal-nav-item"><span>ğŸ“‹</span> <span>All Shipments</span></a>
                </div>
                <div id="admin-nav" style="display: none; margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--color-gray-200);">
                    <div style="padding: 8px 16px; font-size: 0.75rem; color: var(--color-gray-500); text-transform: uppercase;">Admin</div>
                    <a href="admin-panel.html" class="portal-nav-item">
                        <span>ğŸ›¡ï¸</span> <span>Admin Control Panel</span>
                    </a>                    <a href="admin-pickups.html" class="portal-nav-item">
                        <span aria-hidden="true">ğŸš›</span> <span>All Pickup Requests</span>
                    </a>
                    <a href="admin-billing.html" class="portal-nav-item active"><span>ğŸ“</span> <span>Activity Billing</span></a>
                    <a href="invoices.html" class="portal-nav-item"><span>ğŸ’µ</span> <span>Invoices</span></a>
                    <a href="storage-log.html" class="portal-nav-item"><span>ğŸ“Š</span> <span>Storage Log</span></a>
                    <a href="pricing.html" class="portal-nav-item"><span>ğŸ’°</span> <span>Pricing</span></a>
                    <a href="settings.html" class="portal-nav-item"><span>âš™ï¸</span> <span>Settings</span></a>
                    <a href="team.html" class="portal-nav-item"><span>ğŸ‘”</span> <span>Manage Team</span></a>
                </div>
            </nav>
        </aside>

        <main class="portal-main">
            <!-- Header -->
            <div class="page-header-bar">
                <div>
                    <h1>ğŸ“ Activity Billing</h1>
                    <p>Log daily warehouse tasks & bill customers for actual services used</p>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 0.85rem; opacity: 0.8;">Today's Date</div>
                    <div id="today-display" style="font-size: 1.2rem; font-weight: 700;"></div>
                </div>
            </div>

            <!-- Stats -->
            <div class="stats-row">
                <div class="stat-card info">
                    <div class="value" id="stat-today-entries">0</div>
                    <div class="label">Today's Entries</div>
                </div>
                <div class="stat-card warning">
                    <div class="value" id="stat-unbilled">$0</div>
                    <div class="label">Unbilled Activities</div>
                </div>
                <div class="stat-card success">
                    <div class="value" id="stat-month-total">$0</div>
                    <div class="label">This Month Total</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="stat-customers-active">0</div>
                    <div class="label">Active Customers</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="showTab('entry', this)">Log Activity</button>
                <button class="tab" onclick="showTab('history', this)">Activity History</button>
                <button class="tab" onclick="showTab('reconcile', this)">Quote vs Actual</button>
                <button class="tab" onclick="showTab('generate', this)">Generate Invoice</button>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!-- TAB 1: LOG ACTIVITY                            -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="tab-entry" class="tab-content">
                <div class="section-card">
                    <h3>Quick Select Billing Item</h3>
                    <div class="quick-types" id="quick-types">
                        <button class="quick-type" data-type="storage" data-unit="pallet-days" data-rate-key="storage.palletDaily">ğŸ­ Storage</button>
                        <button class="quick-type" data-type="handling" data-unit="orders" data-rate-key="handling.receiving">ğŸ“¥ Handling</button>
                        <button class="quick-type" data-type="pick_pack" data-unit="orders" data-rate-key="handling.pickpack">ğŸ“‹ Pick & Pack</button>
                        <button class="quick-type" data-type="shipping" data-unit="shipments" data-rate-key="">ğŸšš Shipping</button>
                        <button class="quick-type" data-type="wrapping" data-unit="pallets" data-rate-key="handling.wrapping">â¬› Black Wrapping</button>
                        <button class="quick-type" data-type="dropship" data-unit="units" data-rate-key="">ğŸ“¬ Drop Ship</button>
                        <button class="quick-type" data-type="receiving" data-unit="pallets" data-rate-key="handling.receiving">ğŸ“¥ Receiving</button>
                        <button class="quick-type" data-type="labeling" data-unit="items" data-rate-key="handling.labeling">ğŸ·ï¸ Labeling</button>
                        <button class="quick-type" data-type="palletizing" data-unit="pallets" data-rate-key="handling.palletizing">ğŸ“¦ Palletizing</button>
                        <button class="quick-type" data-type="unloading" data-unit="hours" data-rate-key="handling.unloading">â¬‡ï¸ Unloading</button>
                        <button class="quick-type" data-type="loading" data-unit="hours" data-rate-key="handling.loading">â¬†ï¸ Loading</button>
                        <button class="quick-type" data-type="kitting" data-unit="kits" data-rate-key="additional.kitting">ğŸ”§ Kitting</button>
                        <button class="quick-type" data-type="returns" data-unit="items" data-rate-key="additional.returns">ğŸ”„ Returns</button>
                        <button class="quick-type" data-type="rush" data-unit="orders" data-rate-key="additional.rush">âš¡ Rush Handling</button>
                        <button class="quick-type" data-type="pickup_delivery" data-unit="trips" data-rate-key="">ğŸš› Pickup/Delivery</button>
                        <button class="quick-type" data-type="custom" data-unit="units" data-rate-key="">âœï¸ Custom</button>
                    </div>
                </div>

                <div class="section-card">
                    <h3>ğŸ“ Log Daily Activity</h3>
                    <form id="activity-form">
                        <div class="entry-form">
                            <div class="form-group">
                                <label for="entry-customer">Customer *</label>
                                <select id="entry-customer" required>
                                    <option value="">Select customer...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="entry-date">Date *</label>
                                <input type="date" id="entry-date" required>
                            </div>
                            <div class="form-group">
                                <label for="entry-type">Billing Item *</label>
                                <select id="entry-type" required onchange="onActivityTypeChange()">
                                    <option value="">Select item...</option>
                                    <option value="storage">ğŸ­ Storage (Pallet-Days)</option>
                                    <option value="handling">ğŸ“¥ Handling</option>
                                    <option value="pick_pack">ğŸ“‹ Pick & Pack</option>
                                    <option value="shipping">ğŸšš Shipping / Outbound</option>
                                    <option value="wrapping">â¬› Black Wrapping</option>
                                    <option value="dropship">ğŸ“¬ Drop Ship (Units)</option>
                                    <option value="receiving">ğŸ“¥ Receiving / Intake</option>
                                    <option value="labeling">ğŸ·ï¸ Labeling</option>
                                    <option value="palletizing">ğŸ“¦ Palletizing</option>
                                    <option value="unloading">â¬‡ï¸ Unloading</option>
                                    <option value="loading">â¬†ï¸ Loading</option>
                                    <option value="kitting">ğŸ”§ Kitting / Assembly</option>
                                    <option value="returns">ğŸ”„ Returns Processing</option>
                                    <option value="rush">âš¡ Rush Handling</option>
                                    <option value="pickup_delivery">ğŸš› Pickup / Delivery</option>
                                    <option value="container_drayage">ğŸš¢ Container Drayage</option>
                                    <option value="custom">âœï¸ Custom Service</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="entry-quantity">Quantity *</label>
                                <input type="number" id="entry-quantity" min="0.01" step="0.01" required placeholder="0" oninput="updateCalcPreview()">
                            </div>
                            <div class="form-group">
                                <label for="entry-unit">Unit</label>
                                <select id="entry-unit">
                                    <option value="pallets">Pallets</option>
                                    <option value="boxes">Boxes</option>
                                    <option value="items">Items</option>
                                    <option value="orders">Orders</option>
                                    <option value="hours">Hours</option>
                                    <option value="kits">Kits</option>
                                    <option value="trips">Trips</option>
                                    <option value="shipments">Shipments</option>
                                    <option value="pallet-days">Pallet-Days</option>
                                    <option value="containers">Containers</option>
                                    <option value="units">Units</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="entry-rate">Rate ($) *</label>
                                <input type="number" id="entry-rate" min="0" step="0.01" required placeholder="0.00" oninput="updateCalcPreview()">
                                <div class="rate-hint" id="rate-hint">Rate auto-filled from pricing settings</div>
                            </div>
                        </div>
                        <div class="entry-form" style="margin-top: var(--spacing-md);">
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label for="entry-reference">Reference # (PO, BOL, Shipment ID)</label>
                                <input type="text" id="entry-reference" placeholder="Optional reference number...">
                            </div>
                        </div>
                        <div class="entry-form" style="margin-top: var(--spacing-md);">
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label for="entry-notes">Notes</label>
                                <textarea id="entry-notes" rows="2" placeholder="Description of work performed..."></textarea>
                            </div>
                        </div>

                        <!-- Calculated preview -->
                        <div class="calc-preview">
                            <div>
                                <strong>Line Total:</strong>
                                <span id="calc-formula" style="color: var(--color-gray-500); font-size: 0.85rem;"></span>
                            </div>
                            <div class="amount" id="calc-amount">$0.00</div>
                        </div>

                        <div class="btn-row">
                            <button type="submit" class="btn btn-primary">Save Activity</button>
                            <button type="button" class="btn btn-outline" onclick="saveAndAddAnother()">Save & Add Another</button>
                            <button type="reset" class="btn btn-outline" onclick="resetForm()">Clear</button>
                        </div>
                    </form>
                </div>

                <!-- Today's entries quick view -->
                <div class="section-card">
                    <h3>ğŸ“‹ Today's Logged Activities</h3>
                    <div style="overflow-x: auto;">
                    <table class="activity-table" id="today-table">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Activity</th>
                                <th>Qty</th>
                                <th>Unit</th>
                                <th>Rate</th>
                                <th>Amount</th>
                                <th>Ref</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="today-tbody">
                            <tr><td colspan="8" style="text-align: center; padding: 20px; color: var(--color-gray-500);">No activities logged today. Start logging above.</td></tr>
                        </tbody>
                        <tfoot>
                            <tr style="font-weight: 700; background: var(--color-gray-50);">
                                <td colspan="5" style="text-align: right;">Today's Total:</td>
                                <td id="today-total" colspan="3">$0.00</td>
                            </tr>
                        </tfoot>
                    </table>
                    </div>
                </div>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!-- TAB 2: ACTIVITY HISTORY                        -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="tab-history" class="tab-content" style="display: none;">
                <div class="section-card">
                    <h3>ğŸ“… Activity History</h3>
                    <div class="filters-bar">
                        <select id="hist-customer" onchange="loadHistory()">
                            <option value="">All Customers</option>
                        </select>
                        <select id="hist-type" onchange="loadHistory()">
                            <option value="">All Types</option>
                            <option value="receiving">Receiving</option>
                            <option value="storage">Storage</option>
                            <option value="handling">Handling</option>
                            <option value="pick_pack">Pick & Pack</option>
                            <option value="shipping">Shipping</option>
                            <option value="wrapping">Wrapping</option>
                            <option value="dropship">Drop Ship</option>
                            <option value="labeling">Labeling</option>
                            <option value="palletizing">Palletizing</option>
                            <option value="unloading">Unloading</option>
                            <option value="loading">Loading</option>
                            <option value="kitting">Kitting</option>
                            <option value="returns">Returns</option>
                            <option value="rush">Rush</option>
                            <option value="pickup_delivery">Pickup/Delivery</option>
                            <option value="custom">Custom</option>
                        </select>
                        <select id="hist-billed" onchange="loadHistory()">
                            <option value="">All</option>
                            <option value="unbilled">Unbilled Only</option>
                            <option value="billed">Billed Only</option>
                        </select>
                        <input type="date" id="hist-from" onchange="loadHistory()">
                        <span style="color: var(--color-gray-500);">to</span>
                        <input type="date" id="hist-to" onchange="loadHistory()">
                    </div>
                    <div class="table-wrapper" style="overflow-x: auto;">
                        <table class="activity-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Customer</th>
                                    <th>Activity</th>
                                    <th>Qty</th>
                                    <th>Unit</th>
                                    <th>Rate</th>
                                    <th>Amount</th>
                                    <th>Ref</th>
                                    <th>Status</th>
                                    <th>Logged By</th>
                                </tr>
                            </thead>
                            <tbody id="history-tbody">
                                <tr><td colspan="10" style="text-align: center; padding: 20px;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="history-summary" style="margin-top: var(--spacing-md); padding: var(--spacing-md); background: var(--color-gray-50); border-radius: var(--radius-md); font-size: var(--font-size-sm);"></div>
                </div>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!-- TAB 3: QUOTE vs ACTUAL RECONCILIATION          -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="tab-reconcile" class="tab-content" style="display: none;">
                <div class="section-card">
                    <h3>ğŸ“Š Quote vs Actual Comparison</h3>
                    <p style="color: var(--color-gray-500); margin-bottom: var(--spacing-md); font-size: var(--font-size-sm);">
                        Compare what was quoted at shipment creation vs. actual warehouse activities logged. Positive variance = customer owes more than quoted.
                    </p>
                    <div class="filters-bar">
                        <select id="recon-customer" onchange="loadReconciliation()">
                            <option value="">Select Customer...</option>
                        </select>
                        <input type="month" id="recon-month" onchange="loadReconciliation()">
                    </div>
                    <div id="recon-content">
                        <p style="text-align: center; color: var(--color-gray-400); padding: 40px;">Select a customer and month to view reconciliation.</p>
                    </div>
                </div>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!-- TAB 4: GENERATE INVOICE                        -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="tab-generate" class="tab-content" style="display: none;">
                <div class="section-card">
                    <h3>ğŸ’µ Generate Invoice from Activities</h3>
                    <p style="color: var(--color-gray-500); margin-bottom: var(--spacing-md); font-size: var(--font-size-sm);">
                        Aggregate all unbilled activities for a customer into a new invoice. Activities will be grouped by type and linked to the invoice.
                    </p>
                    <div class="entry-form" style="max-width: 600px;">
                        <div class="form-group">
                            <label for="gen-customer">Customer *</label>
                            <select id="gen-customer" required onchange="previewInvoiceActivities()">
                                <option value="">Select customer...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="gen-period-start">Period Start *</label>
                            <input type="date" id="gen-period-start" onchange="previewInvoiceActivities()">
                        </div>
                        <div class="form-group">
                            <label for="gen-period-end">Period End *</label>
                            <input type="date" id="gen-period-end" onchange="previewInvoiceActivities()">
                        </div>
                        <div class="form-group">
                            <label for="gen-due-days">Payment Terms</label>
                            <select id="gen-due-days">
                                <option value="15">Net 15</option>
                                <option value="30" selected>Net 30</option>
                                <option value="45">Net 45</option>
                                <option value="60">Net 60</option>
                            </select>
                        </div>
                    </div>

                    <!-- Invoice Preview -->
                    <div id="gen-preview" style="margin-top: var(--spacing-xl);">
                        <p style="text-align: center; color: var(--color-gray-400); padding: 40px;">Select a customer and date range to preview unbilled activities.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="toast" class="toast"></div>

    <script src="../js/column-prefs.js"></script>
    <script src="../js/lang/es.js"></script>
    <script src="../js/i18n.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, getDoc, getDocs, addDoc, updateDoc, deleteDoc, query, where, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyA4wMm8-QmZGt3lJcZgTpbBa1W_TklrmRg",
            authDomain: "miamialliance3pl.firebaseapp.com",
            projectId: "miamialliance3pl",
            storageBucket: "miamialliance3pl.firebasestorage.app",
            messagingSenderId: "657614666588",
            appId: "1:657614666588:web:20e50484fe5d90b5aa5f99",
            measurementId: "G-KTW0F25ZM1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const FALLBACK_ADMIN_EMAILS = ['ceo@usglatam.com', 'yuri@megalopolisms.com'];

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // BILLING ITEM CATALOG
        // Quote-calculator items are first-class, with operational items
        // mapped back to quote categories for reconciliation.
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const BILLING_ITEMS = {
            storage:           { label: 'Storage',              defaultUnit: 'pallet-days', icon: 'ğŸ­', ratePath: 'storage.palletDaily', fallbackRate: 0.75, quoteKey: 'storage', calculatorItem: true },
            handling:          { label: 'Handling',             defaultUnit: 'orders',      icon: 'ğŸ“¥', ratePath: 'handling.receiving', fallbackRate: 15.00, quoteKey: 'handling', calculatorItem: true },
            pick_pack:         { label: 'Pick & Pack',          defaultUnit: 'orders',      icon: 'ğŸ“‹', ratePath: 'handling.pickpack', fallbackRate: 8.00, quoteKey: 'pick_pack', calculatorItem: true },
            shipping:          { label: 'Shipping / Outbound',  defaultUnit: 'shipments',   icon: 'ğŸšš', ratePath: null,                 fallbackRate: 45.00, quoteKey: 'shipping', calculatorItem: true },
            wrapping:          { label: 'Black Wrapping',       defaultUnit: 'pallets',     icon: 'â¬›', ratePath: 'handling.wrapping', fallbackRate: 7.00, quoteKey: 'wrapping', calculatorItem: true },
            dropship:          { label: 'Drop Ship (Units)',    defaultUnit: 'units',       icon: 'ğŸ“¬', ratePath: null,                 fallbackRate: 0.00, quoteKey: 'dropship', calculatorItem: true },
            receiving:         { label: 'Receiving / Intake',   defaultUnit: 'pallets',     icon: 'ğŸ“¥', ratePath: 'handling.receiving', fallbackRate: 15.00, quoteKey: 'handling', calculatorItem: false },
            labeling:          { label: 'Labeling',             defaultUnit: 'items',       icon: 'ğŸ·ï¸', ratePath: 'handling.labeling', fallbackRate: 0.15, quoteKey: 'handling', calculatorItem: false },
            palletizing:       { label: 'Palletizing',          defaultUnit: 'pallets',     icon: 'ğŸ“¦', ratePath: 'handling.palletizing', fallbackRate: 10.00, quoteKey: 'handling', calculatorItem: false },
            unloading:         { label: 'Unloading',            defaultUnit: 'hours',       icon: 'â¬‡ï¸', ratePath: 'handling.unloading', fallbackRate: 45.00, quoteKey: 'handling', calculatorItem: false },
            loading:           { label: 'Loading',              defaultUnit: 'hours',       icon: 'â¬†ï¸', ratePath: 'handling.loading', fallbackRate: 45.00, quoteKey: 'handling', calculatorItem: false },
            kitting:           { label: 'Kitting / Assembly',   defaultUnit: 'kits',        icon: 'ğŸ”§', ratePath: 'additional.kitting', fallbackRate: 5.00, quoteKey: 'extra', calculatorItem: false },
            returns:           { label: 'Returns Processing',   defaultUnit: 'items',       icon: 'ğŸ”„', ratePath: 'additional.returns', fallbackRate: 2.00, quoteKey: 'extra', calculatorItem: false },
            rush:              { label: 'Rush Handling',        defaultUnit: 'orders',      icon: 'âš¡', ratePath: 'additional.rush', fallbackRate: 25.00, quoteKey: 'extra', calculatorItem: false },
            pickup_delivery:   { label: 'Pickup / Delivery',    defaultUnit: 'trips',       icon: 'ğŸš›', ratePath: null,                 fallbackRate: 120.00, quoteKey: 'extra', calculatorItem: false },
            container_drayage: { label: 'Container Drayage',    defaultUnit: 'containers',  icon: 'ğŸš¢', ratePath: null,                 fallbackRate: 250.00, quoteKey: 'extra', calculatorItem: false },
            custom:            { label: 'Custom Service',       defaultUnit: 'units',       icon: 'âœï¸', ratePath: null,                 fallbackRate: 0.00, quoteKey: 'extra', calculatorItem: false }
        };

        const QUOTE_KEYS = ['storage', 'handling', 'pick_pack', 'shipping', 'wrapping', 'dropship'];

        let customers = [];
        let pricingData = {};
        let currentUser = null;
        let currentUserData = {};
        let customerRateIndex = new Map();

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // UTILITIES
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = 'toast show ' + type;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function getNestedValue(obj, path) {
            if (!path) return undefined;
            return path.split('.').reduce((o, k) => (o || {})[k], obj);
        }

        function normalizeServiceKey(value) {
            return String(value || '')
                .trim()
                .toLowerCase()
                .replace(/&/g, 'and')
                .replace(/[^a-z0-9]+/g, '_')
                .replace(/^_+|_+$/g, '');
        }

        function mapServiceToItem(serviceValue) {
            const key = normalizeServiceKey(serviceValue);
            const directMap = {
                storage: 'storage',
                pallet_storage_daily: 'storage',
                pallet_storage: 'storage',
                receiving: 'receiving',
                handling: 'handling',
                pick_and_pack: 'pick_pack',
                pick_pack: 'pick_pack',
                shipping: 'shipping',
                outbound_shipping: 'shipping',
                wrapping: 'wrapping',
                black_wrapping: 'wrapping',
                drop_ship: 'dropship',
                dropship: 'dropship',
                labeling: 'labeling',
                palletizing: 'palletizing',
                unloading: 'unloading',
                loading: 'loading',
                kitting: 'kitting',
                returns_processing: 'returns',
                returns: 'returns',
                rush_handling: 'rush',
                pickup_delivery: 'pickup_delivery',
                container_drayage: 'container_drayage',
                custom_service: 'custom'
            };

            if (directMap[key]) return directMap[key];
            if (key.includes('pick') && key.includes('pack')) return 'pick_pack';
            if (key.includes('drop') && key.includes('ship')) return 'dropship';
            if (key.includes('wrap')) return 'wrapping';
            if (key.includes('receiv')) return 'receiving';
            if (key.includes('storag')) return 'storage';
            return null;
        }

        function buildCustomerRateIndex() {
            customerRateIndex = new Map();
            const rates = Array.isArray(pricingData?.customerRates) ? pricingData.customerRates : [];

            rates.forEach((row) => {
                const customerId = row?.customerId;
                const itemKey = mapServiceToItem(row?.service);
                const rate = Number(row?.rate);

                if (!customerId || !itemKey || !Number.isFinite(rate)) return;

                let customerMap = customerRateIndex.get(customerId);
                if (!customerMap) {
                    customerMap = new Map();
                    customerRateIndex.set(customerId, customerMap);
                }

                const entry = {
                    rate,
                    unit: String(row?.unit || '').trim(),
                    sourceService: row?.service || itemKey
                };

                customerMap.set(itemKey, entry);

                // Also provide fallback override on the quote category when relevant.
                const quoteKey = BILLING_ITEMS[itemKey]?.quoteKey;
                if (quoteKey && quoteKey !== 'extra' && !customerMap.has(quoteKey)) {
                    customerMap.set(quoteKey, entry);
                }
            });
        }

        function resolveCustomerRate(customerId, activityType) {
            if (!customerId || !activityType) return null;
            const customerMap = customerRateIndex.get(customerId);
            if (!customerMap) return null;

            if (customerMap.has(activityType)) {
                return customerMap.get(activityType);
            }

            const quoteKey = getQuoteCategory(activityType);
            if (quoteKey && quoteKey !== 'extra' && customerMap.has(quoteKey)) {
                return customerMap.get(quoteKey);
            }

            return null;
        }

        function getRateMeta(activityType, customerId) {
            const item = BILLING_ITEMS[activityType];
            if (!item) {
                return { rate: 0, source: 'unknown', path: null, customerRate: null };
            }

            const customerRate = resolveCustomerRate(customerId, activityType);
            if (customerRate) {
                return {
                    rate: Number(customerRate.rate) || 0,
                    source: 'customer',
                    path: null,
                    customerRate
                };
            }

            if (item.ratePath) {
                const value = getNestedValue(pricingData, item.ratePath);
                if (value !== undefined && value !== null && Number.isFinite(Number(value))) {
                    return {
                        rate: Number(value),
                        source: 'pricing',
                        path: item.ratePath,
                        customerRate: null
                    };
                }
            }

            return {
                rate: Number(item.fallbackRate) || 0,
                source: 'fallback',
                path: item.ratePath || null,
                customerRate: null
            };
        }

        function getRateForType(activityType, customerId) {
            return getRateMeta(activityType, customerId).rate;
        }

        function formatCurrency(n) {
            return '$' + (Number(n) || 0).toFixed(2);
        }

        function getActivityLabel(type) {
            return BILLING_ITEMS[type]?.label || type;
        }

        function getActivityIcon(type) {
            return BILLING_ITEMS[type]?.icon || 'ğŸ“';
        }

        function getQuoteCategory(activityType) {
            const quoteKey = BILLING_ITEMS[activityType]?.quoteKey;
            return quoteKey || 'extra';
        }

        function getQuoteCategoryLabel(quoteKey) {
            const map = {
                storage: 'Storage',
                handling: 'Handling',
                pick_pack: 'Pick & Pack',
                shipping: 'Shipping',
                wrapping: 'Black Wrapping',
                dropship: 'Drop Ship',
                extra: 'Extra / Unquoted'
            };
            return map[quoteKey] || quoteKey;
        }

        function todayStr() {
            return new Date().toISOString().split('T')[0];
        }

        function firstOfMonth() {
            const d = new Date();
            return new Date(d.getFullYear(), d.getMonth(), 1).toISOString().split('T')[0];
        }

        function lastOfMonth() {
            const d = new Date();
            return new Date(d.getFullYear(), d.getMonth() + 1, 0).toISOString().split('T')[0];
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // TAB SWITCHING
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        window.showTab = function(tab, tabButton) {
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tab).style.display = 'block';
            if (tabButton) {
                tabButton.classList.add('active');
            } else {
                const fallbackBtn = document.querySelector(`.tab[onclick*="showTab('${tab}'"]`);
                if (fallbackBtn) fallbackBtn.classList.add('active');
            }

            if (tab === 'history') loadHistory();
            if (tab === 'reconcile') {}
            if (tab === 'generate') {}
        };

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // INIT
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = '../login.html';
                return;
            }

            currentUser = user;
            const userDoc = await getDoc(doc(db, 'users', user.uid));
            currentUserData = userDoc.exists() ? userDoc.data() : {};
            const userRole = currentUserData.role || (FALLBACK_ADMIN_EMAILS.includes(user.email.toLowerCase()) ? 'admin' : 'customer');

            if (userRole !== 'admin' && userRole !== 'employee') {
                window.location.href = 'dashboard.html';
                return;
            }

            document.getElementById('user-name').textContent = currentUserData.name || user.email;
            document.getElementById('employee-nav').style.display = 'block';
            if (userRole === 'admin') {
                document.getElementById('admin-nav').style.display = 'block';
            }

            // Set defaults
            document.getElementById('today-display').textContent = new Date().toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
            document.getElementById('entry-date').value = todayStr();
            document.getElementById('hist-from').value = firstOfMonth();
            document.getElementById('hist-to').value = todayStr();
            document.getElementById('recon-month').value = new Date().toISOString().slice(0, 7);
            document.getElementById('gen-period-start').value = firstOfMonth();
            document.getElementById('gen-period-end').value = lastOfMonth();

            await loadCustomers();
            await loadPricing();
            await loadTodayActivities();
            await loadStats();
            setupQuickTypes();
            document.getElementById('entry-customer').addEventListener('change', () => {
                const type = document.getElementById('entry-type').value;
                if (type) applyDefaultRate(type);
            });
        });

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // LOAD CUSTOMERS & PRICING
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadCustomers() {
            const snap = await getDocs(collection(db, 'users'));
            customers = [];
            snap.forEach(d => {
                const data = d.data();
                if (!data.role || data.role === 'customer') {
                    customers.push({ id: d.id, ...data });
                }
            });

            const selects = ['entry-customer', 'hist-customer', 'recon-customer', 'gen-customer'];
            selects.forEach(id => {
                const select = document.getElementById(id);
                const first = select.options[0];
                select.innerHTML = '';
                select.appendChild(first);
                customers.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = c.company_name || c.name || c.email;
                    select.appendChild(opt);
                });
            });
        }

        async function loadPricing() {
            const pricingDoc = await getDoc(doc(db, 'settings', 'pricing'));
            pricingData = pricingDoc.exists() ? pricingDoc.data() : {};
            buildCustomerRateIndex();
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // QUICK TYPE BUTTONS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function setupQuickTypes() {
            document.querySelectorAll('.quick-type').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const type = btn.dataset.type;
                    document.getElementById('entry-type').value = type;
                    applyDefaultRate(type);

                    // Highlight selected
                    document.querySelectorAll('.quick-type').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');

                    updateCalcPreview();

                    // Focus quantity
                    document.getElementById('entry-quantity').focus();
                });
            });
        }

        function applyDefaultRate(activityType) {
            const info = BILLING_ITEMS[activityType];
            if (!info) return;

            const customerId = document.getElementById('entry-customer').value || null;
            const rateMeta = getRateMeta(activityType, customerId);

            if (info.defaultUnit) {
                document.getElementById('entry-unit').value = info.defaultUnit;
            }
            document.getElementById('entry-rate').value = rateMeta.rate;

            const sourceLabel = rateMeta.source === 'customer'
                ? `customer override (${rateMeta.customerRate?.sourceService || activityType})`
                : (rateMeta.source === 'pricing'
                    ? `pricing settings${rateMeta.path ? ' (' + rateMeta.path + ')' : ''}`
                    : 'fallback default');

            document.getElementById('rate-hint').textContent =
                `Default from ${sourceLabel}: ${formatCurrency(rateMeta.rate)}/${info.defaultUnit}`;

            updateCalcPreview();
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ACTIVITY TYPE CHANGE
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        window.onActivityTypeChange = function() {
            const type = document.getElementById('entry-type').value;
            if (!type) return;

            applyDefaultRate(type);

            // Update quick type highlights
            document.querySelectorAll('.quick-type').forEach(b => {
                b.classList.toggle('selected', b.dataset.type === type);
            });
        };

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CALC PREVIEW
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        window.updateCalcPreview = function() {
            const qty = parseFloat(document.getElementById('entry-quantity').value) || 0;
            const rate = parseFloat(document.getElementById('entry-rate').value) || 0;
            const amount = qty * rate;
            const unit = document.getElementById('entry-unit').value;

            document.getElementById('calc-amount').textContent = formatCurrency(amount);
            document.getElementById('calc-formula').textContent =
                qty > 0 ? `${qty} ${unit} x ${formatCurrency(rate)} = ` : '';
        };

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // SAVE ACTIVITY
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function saveActivity() {
            const customerId = document.getElementById('entry-customer').value;
            const customer = customers.find(c => c.id === customerId);
            const activityType = document.getElementById('entry-type').value;
            const quantity = parseFloat(document.getElementById('entry-quantity').value) || 0;
            const rate = parseFloat(document.getElementById('entry-rate').value) || 0;
            const unit = document.getElementById('entry-unit').value;

            if (!customerId || !activityType || quantity <= 0) {
                showToast('Please fill all required fields', 'error');
                return false;
            }

            const quoteCategory = getQuoteCategory(activityType);
            const rateMeta = getRateMeta(activityType, customerId);
            const manualRateOverride = Math.abs(rate - (Number(rateMeta.rate) || 0)) > 0.0001;
            const item = BILLING_ITEMS[activityType] || {};

            const activity = {
                customer_id: customerId,
                customer_name: customer?.company_name || customer?.name || customer?.email || 'Unknown',
                date: document.getElementById('entry-date').value,
                activity_type: activityType,
                billing_item_id: activityType,
                billing_item_label: getActivityLabel(activityType),
                quote_category: quoteCategory,
                calculator_item: Boolean(item.calculatorItem),
                description: getActivityLabel(activityType),
                quantity: quantity,
                unit: unit,
                rate: rate,
                amount: quantity * rate,
                rate_source: manualRateOverride ? 'manual_override' : rateMeta.source,
                pricing_rate_path: rateMeta.path || null,
                pricing_rate_default: Number(rateMeta.rate) || 0,
                customer_rate_applied: rateMeta.source === 'customer',
                reference: document.getElementById('entry-reference').value.trim(),
                notes: document.getElementById('entry-notes').value.trim(),
                logged_by: currentUser.uid,
                logged_by_name: currentUserData.name || currentUser.email,
                logged_by_email: currentUser.email,
                billed: false,
                invoice_id: null,
                created_at: new Date().toISOString()
            };

            try {
                await addDoc(collection(db, 'activity_log'), activity);
                showToast(`Activity logged: ${getActivityIcon(activityType)} ${getActivityLabel(activityType)} - ${formatCurrency(activity.amount)}`);
                return true;
            } catch (err) {
                showToast('Error saving: ' + err.message, 'error');
                return false;
            }
        }

        document.getElementById('activity-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const saved = await saveActivity();
            if (saved) {
                resetForm();
                await loadTodayActivities();
                await loadStats();
            }
        });

        window.saveAndAddAnother = async function() {
            const saved = await saveActivity();
            if (saved) {
                // Keep customer and date, clear the rest
                const customer = document.getElementById('entry-customer').value;
                const date = document.getElementById('entry-date').value;
                document.getElementById('activity-form').reset();
                document.getElementById('entry-customer').value = customer;
                document.getElementById('entry-date').value = date;
                document.querySelectorAll('.quick-type').forEach(b => b.classList.remove('selected'));
                updateCalcPreview();
                await loadTodayActivities();
                await loadStats();
                document.getElementById('entry-type').focus();
            }
        };

        window.resetForm = function() {
            document.getElementById('activity-form').reset();
            document.getElementById('entry-date').value = todayStr();
            document.querySelectorAll('.quick-type').forEach(b => b.classList.remove('selected'));
            document.getElementById('rate-hint').textContent = 'Rate auto-filled from customer override / pricing settings';
            document.getElementById('calc-amount').textContent = '$0.00';
            document.getElementById('calc-formula').textContent = '';
        };

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // TODAY'S ACTIVITIES
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadTodayActivities() {
            const today = todayStr();
            const q = query(
                collection(db, 'activity_log'),
                where('date', '==', today),
                orderBy('created_at', 'desc')
            );

            try {
                const snap = await getDocs(q);
                const tbody = document.getElementById('today-tbody');
                tbody.innerHTML = '';

                let todayTotal = 0;
                let todayCount = 0;

                if (snap.empty) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px; color: var(--color-gray-500);">No activities logged today. Start logging above.</td></tr>';
                } else {
                    snap.forEach(d => {
                        const a = d.data();
                        const itemType = a.billing_item_id || a.activity_type;
                        todayTotal += a.amount || 0;
                        todayCount++;
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${a.customer_name}</td>
                            <td>${getActivityIcon(itemType)} ${getActivityLabel(itemType)}</td>
                            <td>${a.quantity}</td>
                            <td>${a.unit}</td>
                            <td>${formatCurrency(a.rate)}</td>
                            <td><strong>${formatCurrency(a.amount)}</strong></td>
                            <td>${a.reference || '-'}</td>
                            <td><button class="btn-delete" onclick="deleteActivity('${d.id}')">Delete</button></td>
                        `;
                        tbody.appendChild(row);
                    });
                }

                document.getElementById('today-total').textContent = formatCurrency(todayTotal);
                document.getElementById('stat-today-entries').textContent = todayCount;
            } catch (err) {
                console.error('Error loading today activities:', err);
            }
        }

        window.deleteActivity = async function(id) {
            if (!confirm('Delete this activity entry?')) return;
            try {
                await deleteDoc(doc(db, 'activity_log', id));
                showToast('Activity deleted');
                await loadTodayActivities();
                await loadStats();
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            }
        };

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // STATS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadStats() {
            try {
                // Unbilled activities
                const unbilledQ = query(
                    collection(db, 'activity_log'),
                    where('billed', '==', false)
                );
                const unbilledSnap = await getDocs(unbilledQ);
                let unbilledTotal = 0;
                let activeCustomerSet = new Set();

                unbilledSnap.forEach(d => {
                    const a = d.data();
                    unbilledTotal += a.amount || 0;
                    activeCustomerSet.add(a.customer_id);
                });

                document.getElementById('stat-unbilled').textContent = formatCurrency(unbilledTotal);
                document.getElementById('stat-customers-active').textContent = activeCustomerSet.size;

                // Month total
                const monthStart = firstOfMonth();
                const monthEnd = lastOfMonth();
                const monthQ = query(
                    collection(db, 'activity_log'),
                    where('date', '>=', monthStart),
                    where('date', '<=', monthEnd)
                );
                const monthSnap = await getDocs(monthQ);
                let monthTotal = 0;
                monthSnap.forEach(d => {
                    monthTotal += d.data().amount || 0;
                });
                document.getElementById('stat-month-total').textContent = formatCurrency(monthTotal);

            } catch (err) {
                console.error('Stats error:', err);
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // HISTORY TAB
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        window.loadHistory = async function() {
            const customerId = document.getElementById('hist-customer').value;
            const activityType = document.getElementById('hist-type').value;
            const billedFilter = document.getElementById('hist-billed').value;
            const fromDate = document.getElementById('hist-from').value;
            const toDate = document.getElementById('hist-to').value;

            let q = collection(db, 'activity_log');
            const constraints = [];

            if (customerId) constraints.push(where('customer_id', '==', customerId));
            if (activityType) constraints.push(where('activity_type', '==', activityType));
            if (billedFilter === 'unbilled') constraints.push(where('billed', '==', false));
            if (billedFilter === 'billed') constraints.push(where('billed', '==', true));
            if (fromDate) constraints.push(where('date', '>=', fromDate));
            if (toDate) constraints.push(where('date', '<=', toDate));

            constraints.push(orderBy('date', 'desc'));
            q = query(q, ...constraints);

            try {
                const snap = await getDocs(q);
                const tbody = document.getElementById('history-tbody');
                tbody.innerHTML = '';

                let total = 0;
                let count = 0;
                let typeTotals = {};

                if (snap.empty) {
                    tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 20px;">No activities found for the selected filters.</td></tr>';
                } else {
                    snap.forEach(d => {
                        const a = d.data();
                        const itemType = a.billing_item_id || a.activity_type;
                        total += a.amount || 0;
                        count++;
                        typeTotals[itemType] = (typeTotals[itemType] || 0) + (a.amount || 0);

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${a.date}</td>
                            <td>${a.customer_name}</td>
                            <td>${getActivityIcon(itemType)} ${getActivityLabel(itemType)}</td>
                            <td>${a.quantity}</td>
                            <td>${a.unit}</td>
                            <td>${formatCurrency(a.rate)}</td>
                            <td><strong>${formatCurrency(a.amount)}</strong></td>
                            <td>${a.reference || '-'}</td>
                            <td><span class="badge ${a.billed ? 'badge-billed' : 'badge-unbilled'}">${a.billed ? 'Billed' : 'Unbilled'}</span></td>
                            <td>${a.logged_by_name || a.logged_by_email || 'Staff'}</td>
                        `;
                        tbody.appendChild(row);
                    });
                }

                // Summary
                const summaryDiv = document.getElementById('history-summary');
                const typeBreakdown = Object.entries(typeTotals)
                    .sort((a, b) => b[1] - a[1])
                    .map(([type, amt]) => `<strong>${getActivityLabel(type)}</strong>: ${formatCurrency(amt)}`)
                    .join(' &bull; ');

                summaryDiv.innerHTML = count > 0
                    ? `<strong>${count} entries</strong> &bull; Total: <strong>${formatCurrency(total)}</strong><br><span style="color: var(--color-gray-500);">${typeBreakdown}</span>`
                    : '';

            } catch (err) {
                console.error('History error:', err);
                showToast('Error loading history', 'error');
            }
        };

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // RECONCILIATION TAB
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        window.loadReconciliation = async function() {
            const customerId = document.getElementById('recon-customer').value;
            const month = document.getElementById('recon-month').value;

            if (!customerId || !month) {
                document.getElementById('recon-content').innerHTML =
                    '<p style="text-align: center; color: var(--color-gray-400); padding: 40px;">Select a customer and month to view reconciliation.</p>';
                return;
            }

            const start = month + '-01';
            const end = month + '-31';
            const customer = customers.find(c => c.id === customerId);

            try {
                // 1. Get quoted amounts from shipments created this month
                const shipmentsQ = query(
                    collection(db, 'shipments'),
                    where('user_id', '==', customerId),
                    where('created_at', '>=', start),
                    where('created_at', '<=', end + 'T23:59:59')
                );
                const shipmentsSnap = await getDocs(shipmentsQ);

                let quotedTotals = {
                    storage: 0,
                    handling: 0,
                    pick_pack: 0,
                    shipping: 0,
                    wrapping: 0,
                    dropship: 0,
                    total: 0
                };
                shipmentsSnap.forEach(d => {
                    const s = d.data();
                    const charges = s.quote_estimate || s.charges || s.quote_breakdown || {};
                    quotedTotals.storage += Number(charges.storage) || 0;
                    quotedTotals.handling += Number(charges.handling) || 0;
                    quotedTotals.pick_pack += Number(charges.pickPack ?? charges.pick_pack) || 0;
                    quotedTotals.shipping += Number(charges.shipping) || 0;
                    quotedTotals.wrapping += Number(charges.wrapping) || 0;
                    quotedTotals.dropship += Number(charges.dropship) || 0;
                    quotedTotals.total += Number(charges.total ?? s.total_charges) || 0;
                });

                // 2. Get actual activities logged this month
                const activitiesQ = query(
                    collection(db, 'activity_log'),
                    where('customer_id', '==', customerId),
                    where('date', '>=', start),
                    where('date', '<=', end)
                );
                const activitiesSnap = await getDocs(activitiesQ);

                const actualByCategory = {
                    storage: 0,
                    handling: 0,
                    pick_pack: 0,
                    shipping: 0,
                    wrapping: 0,
                    dropship: 0,
                    extra: 0
                };
                const extraItemTotals = {};
                activitiesSnap.forEach(d => {
                    const a = d.data();
                    const itemType = a.billing_item_id || a.activity_type || 'custom';
                    const quoteCategory = a.quote_category || getQuoteCategory(itemType);
                    const amount = Number(a.amount) || 0;
                    if (QUOTE_KEYS.includes(quoteCategory)) {
                        actualByCategory[quoteCategory] = (actualByCategory[quoteCategory] || 0) + amount;
                    } else {
                        actualByCategory.extra += amount;
                        extraItemTotals[itemType] = (extraItemTotals[itemType] || 0) + amount;
                    }
                });

                // 3. Render reconciliation
                const content = document.getElementById('recon-content');
                let rows = '';
                let totalQuoted = 0;
                let totalActual = 0;

                QUOTE_KEYS.forEach((key) => {
                    const quoted = Number(quotedTotals[key]) || 0;
                    const actual = Number(actualByCategory[key]) || 0;
                    if (quoted === 0 && actual === 0) return;

                    const variance = actual - quoted;
                    totalQuoted += quoted;
                    totalActual += actual;

                    let varianceClass = 'variance-zero';
                    let varianceStr = formatCurrency(0);
                    if (variance > 0.01) {
                        varianceClass = 'variance-positive';
                        varianceStr = '+' + formatCurrency(variance);
                    } else if (variance < -0.01) {
                        varianceClass = 'variance-negative';
                        varianceStr = '-' + formatCurrency(Math.abs(variance));
                    }

                    rows += `
                        <div class="recon-row">
                            <div>${getQuoteCategoryLabel(key)}</div>
                            <div>${formatCurrency(quoted)}</div>
                            <div>${formatCurrency(actual)}</div>
                            <div class="${varianceClass}">${varianceStr}</div>
                        </div>
                    `;
                });

                Object.entries(extraItemTotals)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([itemType, actual]) => {
                        if (!actual) return;
                        totalActual += actual;
                        rows += `
                            <div class="recon-row">
                                <div>${getActivityIcon(itemType)} ${getActivityLabel(itemType)} <span style="font-size: 0.75rem; color: var(--color-gray-500);">(unquoted)</span></div>
                                <div>${formatCurrency(0)}</div>
                                <div>${formatCurrency(actual)}</div>
                                <div class="variance-positive">+${formatCurrency(actual)}</div>
                            </div>
                        `;
                    });

                const grandVariance = totalActual - totalQuoted;
                let grandVarianceClass = 'variance-zero';
                let grandVarianceStr = formatCurrency(0);
                if (grandVariance > 0.01) {
                    grandVarianceClass = 'variance-positive';
                    grandVarianceStr = '+' + formatCurrency(grandVariance);
                } else if (grandVariance < -0.01) {
                    grandVarianceClass = 'variance-negative';
                    grandVarianceStr = '-' + formatCurrency(Math.abs(grandVariance));
                }

                content.innerHTML = `
                    <div class="reconciliation-card">
                        <h4 style="margin-bottom: var(--spacing-md);">${customer?.company_name || customer?.name} â€” ${month}</h4>
                        <div class="recon-row header">
                            <div>Service Category</div>
                            <div>Quoted</div>
                            <div>Actual</div>
                            <div>Variance</div>
                        </div>
                        ${rows || '<div class="recon-row"><div colspan="4" style="text-align: center; color: var(--color-gray-400); grid-column: 1/-1;">No data for this period</div></div>'}
                        <div class="recon-total">
                            <span>Grand Total</span>
                            <span style="display: flex; gap: var(--spacing-xl);">
                                <span>Quoted: ${formatCurrency(totalQuoted)}</span>
                                <span>Actual: ${formatCurrency(totalActual)}</span>
                                <span class="${grandVarianceClass}">${grandVarianceStr}</span>
                            </span>
                        </div>
                        ${Math.abs(grandVariance) > 0.01 ? `
                        <div style="margin-top: var(--spacing-md); padding: var(--spacing-md); background: ${grandVariance > 0 ? '#fef2f2' : '#f0fdf4'}; border-radius: var(--radius-md); font-size: var(--font-size-sm);">
                            ${grandVariance > 0
                                ? `<strong style="color: #dc2626;">Customer owes ${formatCurrency(grandVariance)} more</strong> than the original quote. Actual services exceeded the estimate.`
                                : `<strong style="color: #059669;">Customer was charged ${formatCurrency(Math.abs(grandVariance))} less</strong> than quoted. Actual services were below the estimate.`
                            }
                        </div>` : ''}
                    </div>
                `;

            } catch (err) {
                console.error('Reconciliation error:', err);
                document.getElementById('recon-content').innerHTML =
                    `<p style="color: #ef4444; text-align: center; padding: 20px;">Error loading data: ${err.message}</p>`;
            }
        };

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // GENERATE INVOICE TAB
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let previewActivities = [];

        window.previewInvoiceActivities = async function() {
            const customerId = document.getElementById('gen-customer').value;
            const periodStart = document.getElementById('gen-period-start').value;
            const periodEnd = document.getElementById('gen-period-end').value;

            if (!customerId || !periodStart || !periodEnd) {
                document.getElementById('gen-preview').innerHTML =
                    '<p style="text-align: center; color: var(--color-gray-400); padding: 40px;">Select a customer and date range to preview unbilled activities.</p>';
                return;
            }

            const customer = customers.find(c => c.id === customerId);

            try {
                const q = query(
                    collection(db, 'activity_log'),
                    where('customer_id', '==', customerId),
                    where('billed', '==', false),
                    where('date', '>=', periodStart),
                    where('date', '<=', periodEnd),
                    orderBy('date', 'asc')
                );
                const snap = await getDocs(q);

                previewActivities = [];
                snap.forEach(d => {
                    previewActivities.push({ id: d.id, ...d.data() });
                });

                // Group by billing item + rate for invoice line items
                const grouped = {};
                previewActivities.forEach(a => {
                    const itemType = a.billing_item_id || a.activity_type || 'custom';
                    const quoteCategory = a.quote_category || getQuoteCategory(itemType);
                    const key = [itemType, a.unit, Number(a.rate || 0).toFixed(4)].join('|');
                    if (!grouped[key]) {
                        grouped[key] = {
                            billing_item_id: itemType,
                            quote_category: quoteCategory,
                            description: getActivityLabel(itemType),
                            unit: a.unit,
                            rate: Number(a.rate) || 0,
                            quantity: 0,
                            amount: 0,
                            entries: 0,
                            ids: []
                        };
                    }
                    grouped[key].quantity += Number(a.quantity) || 0;
                    grouped[key].amount += Number(a.amount) || 0;
                    grouped[key].entries++;
                    grouped[key].ids.push(a.id);
                });

                const lineItems = Object.values(grouped).sort((a, b) => b.amount - a.amount);
                const grandTotal = lineItems.reduce((sum, li) => sum + li.amount, 0);

                if (lineItems.length === 0) {
                    document.getElementById('gen-preview').innerHTML =
                        '<p style="text-align: center; color: var(--color-gray-400); padding: 40px;">No unbilled activities found for this customer in the selected period.</p>';
                    return;
                }

                let tableRows = lineItems.map(li => `
                    <tr>
                        <td>${getActivityIcon(li.billing_item_id)} ${li.description}</td>
                        <td>${li.quantity.toFixed(2)}</td>
                        <td>${li.unit}</td>
                        <td>${formatCurrency(li.rate)}</td>
                        <td><strong>${formatCurrency(li.amount)}</strong></td>
                        <td style="color: var(--color-gray-400);">${li.entries} entries &bull; ${getQuoteCategoryLabel(li.quote_category)}</td>
                    </tr>
                `).join('');

                document.getElementById('gen-preview').innerHTML = `
                    <div class="section-card" style="border: 2px solid var(--color-primary);">
                        <h4 style="margin-bottom: var(--spacing-sm);">Invoice Preview â€” ${customer?.company_name || customer?.name}</h4>
                        <p style="color: var(--color-gray-500); font-size: var(--font-size-sm); margin-bottom: var(--spacing-md);">
                            Period: ${periodStart} to ${periodEnd} &bull; ${previewActivities.length} activity entries
                        </p>
                        <table class="activity-table">
                            <thead>
                                <tr>
                                    <th>Service</th>
                                    <th>Qty</th>
                                    <th>Unit</th>
                                    <th>Rate</th>
                                    <th>Amount</th>
                                    <th>Detail</th>
                                </tr>
                            </thead>
                            <tbody>${tableRows}</tbody>
                            <tfoot>
                                <tr style="font-weight: 700; background: var(--color-gray-50);">
                                    <td colspan="4" style="text-align: right;">Grand Total:</td>
                                    <td colspan="2" style="font-size: var(--font-size-lg);">${formatCurrency(grandTotal)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div class="generate-invoice-bar">
                        <div class="info">
                            <h3>Ready to Generate Invoice</h3>
                            <p>${lineItems.length} line items &bull; ${previewActivities.length} activities &bull; ${formatCurrency(grandTotal)} total</p>
                        </div>
                        <button class="btn-generate" onclick="generateInvoiceFromActivities()">Generate Invoice</button>
                    </div>
                `;

            } catch (err) {
                console.error('Preview error:', err);
                document.getElementById('gen-preview').innerHTML =
                    `<p style="color: #ef4444; text-align: center;">${err.message}</p>`;
            }
        };

        window.generateInvoiceFromActivities = async function() {
            const customerId = document.getElementById('gen-customer').value;
            const customer = customers.find(c => c.id === customerId);
            const periodStart = document.getElementById('gen-period-start').value;
            const periodEnd = document.getElementById('gen-period-end').value;
            const dueDays = parseInt(document.getElementById('gen-due-days').value);

            if (previewActivities.length === 0) {
                showToast('No activities to invoice', 'error');
                return;
            }

            // Group activities into line items
            const grouped = {};
            previewActivities.forEach(a => {
                const itemType = a.billing_item_id || a.activity_type || 'custom';
                const quoteCategory = a.quote_category || getQuoteCategory(itemType);
                const key = [itemType, a.unit, Number(a.rate || 0).toFixed(4)].join('|');
                if (!grouped[key]) {
                    grouped[key] = {
                        category: quoteCategory,
                        billing_item_id: itemType,
                        description: getActivityLabel(itemType),
                        unit: a.unit,
                        rate: Number(a.rate) || 0,
                        quantity: 0,
                        amount: 0
                    };
                }
                grouped[key].quantity += Number(a.quantity) || 0;
                grouped[key].amount += Number(a.amount) || 0;
            });

            const lineItems = Object.values(grouped);
            const subtotal = lineItems.reduce((sum, li) => sum + li.amount, 0);

            // Generate invoice number
            const now = new Date();
            const invNumber = 'INV-' + now.getFullYear() + '-' +
                String(now.getMonth() + 1).padStart(2, '0') + '-' +
                String(Math.floor(Math.random() * 9000) + 1000);

            const dueDate = new Date(now.getTime() + dueDays * 24 * 60 * 60 * 1000);

            const invoice = {
                invoice_number: invNumber,
                customer_id: customerId,
                customer_name: customer?.company_name || customer?.name || customer?.email,
                customer_email: customer?.email,
                billing_period_start: periodStart,
                billing_period_end: periodEnd,
                billing_cycle: 'activity-based',
                due_date: dueDate.toISOString().split('T')[0],
                line_items: lineItems,
                subtotal: subtotal,
                tax_rate: 0,
                tax_amount: 0,
                total: subtotal,
                amount_paid: 0,
                status: 'draft',
                notes: `Generated from ${previewActivities.length} activity log entries (${periodStart} to ${periodEnd}). Activity-based billing.`,
                source: 'activity_billing',
                activity_count: previewActivities.length,
                created_at: now.toISOString(),
                created_by: currentUser.uid
            };

            try {
                // 1. Create invoice
                const invoiceRef = await addDoc(collection(db, 'invoices'), invoice);

                // 2. Mark all activities as billed
                for (const activity of previewActivities) {
                    await updateDoc(doc(db, 'activity_log', activity.id), {
                        billed: true,
                        invoice_id: invoiceRef.id
                    });
                }

                showToast(`Invoice ${invNumber} created! Total: ${formatCurrency(subtotal)}`);

                // Reset preview
                previewActivities = [];
                document.getElementById('gen-preview').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 3rem;">âœ…</div>
                        <h3 style="margin: var(--spacing-md) 0;">Invoice ${invNumber} Created</h3>
                        <p style="color: var(--color-gray-500);">Total: ${formatCurrency(subtotal)} &bull; Status: Draft</p>
                        <a href="invoices.html" class="btn btn-primary" style="margin-top: var(--spacing-md); display: inline-block; text-decoration: none;">View in Invoices</a>
                    </div>
                `;

                await loadStats();

            } catch (err) {
                showToast('Error creating invoice: ' + err.message, 'error');
            }
        };

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // LOGOUT
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        document.getElementById('logout-btn').addEventListener('click', async () => {
            await signOut(auth);
            window.location.href = '../login.html';
        });
    </script>
</body>
</html>
