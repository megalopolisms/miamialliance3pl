<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Miami Alliance 3PL Portal</title>
    <meta name="robots" content="noindex, nofollow">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì¶</text></svg>">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="../css/style.css?v=8">
    <style>
        .admin-badge {
            background: linear-gradient(135deg, #f97316, #ea580c);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }
        .welcome-hero {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            color: white;
            padding: var(--spacing-xl);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-xl);
        }
        .welcome-hero h1 {
            font-size: var(--font-size-3xl);
            margin-bottom: var(--spacing-xs);
        }
        .welcome-hero p {
            opacity: 0.9;
            font-size: var(--font-size-lg);
        }
        .admin-section {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }
        .admin-section h2 {
            color: #92400e;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-top: var(--spacing-md);
        }
        .admin-card {
            background: white;
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .admin-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        .admin-card .icon {
            font-size: 2rem;
            margin-bottom: var(--spacing-xs);
        }
        .admin-card .label {
            font-weight: 600;
            color: var(--color-gray-700);
        }
        .admin-card .count {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: var(--color-primary);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <header class="header">
        <nav class="nav container">
            <a href="../index.html" class="logo">
                <span class="logo-text">MIAMI ALLIANCE <span class="logo-accent">3PL</span></span>
            </a>
            <button class="nav-toggle sidebar-toggle" aria-label="Toggle sidebar">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <ul class="nav-menu">
                <li><span id="user-name" class="nav-link">Welcome</span></li>
                <li><a href="#" id="logout-btn" class="nav-link btn btn-outline">Logout</a></li>
            </ul>
        </nav>
    </header>

    <div class="portal-layout">
        <!-- Sidebar -->
        <aside class="portal-sidebar">
            <nav>
                <a href="dashboard.html" class="portal-nav-item active">
                    <span>üìä</span> Dashboard
                </a>
                <a href="shipments.html" class="portal-nav-item">
                    <span>üöö</span> Shipments
                </a>
                <a href="tracking.html" class="portal-nav-item">
                    <span>üîç</span> Tracking
                </a>
                <a href="inventory.html" class="portal-nav-item">
                    <span>üì¶</span> Inventory
                </a>
                <div id="admin-nav" style="display: none; margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--color-gray-200);">
                    <div style="padding: 8px 16px; font-size: 0.75rem; color: var(--color-gray-500); text-transform: uppercase;">Admin</div>
                    <a href="customers.html" class="portal-nav-item" id="nav-all-users">
                        <span>üë•</span> All Customers
                    </a>
                    <a href="admin-shipments.html" class="portal-nav-item" id="nav-all-shipments">
                        <span>üìã</span> All Shipments
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="portal-main">
            <!-- Welcome Hero -->
            <div class="welcome-hero">
                <h1 id="welcome-title">Welcome back!</h1>
                <p id="welcome-subtitle">Here's what's happening with your logistics today.</p>
                <p id="jorge-quote" style="display: none; margin-top: var(--spacing-md); font-style: italic; opacity: 0.8; font-size: var(--font-size-lg);">"Do or do not ship. There is no try." - Master Yoda, Logistics Division</p>
            </div>

            <!-- Admin Section (hidden by default) -->
            <div id="admin-section" class="admin-section" style="display: none;">
                <h2 id="admin-title">üëë Admin Dashboard</h2>
                <p id="admin-subtitle" style="color: #92400e; margin-bottom: var(--spacing-sm);">You have full access to manage all customers and shipments.</p>
                <div class="admin-grid">
                    <div class="admin-card" onclick="location.href='#users'">
                        <div class="icon">üë•</div>
                        <div class="count" id="total-users">0</div>
                        <div class="label" id="label-users">Total Customers</div>
                    </div>
                    <div class="admin-card" onclick="location.href='#shipments'">
                        <div class="icon" id="icon-shipments">üì¶</div>
                        <div class="count" id="total-shipments">0</div>
                        <div class="label" id="label-shipments">Total Shipments</div>
                    </div>
                    <div class="admin-card" onclick="location.href='#inventory'">
                        <div class="icon" id="icon-inventory">üè≠</div>
                        <div class="count" id="total-inventory">0</div>
                        <div class="label" id="label-inventory">Inventory Items</div>
                    </div>
                    <div class="admin-card" onclick="location.href='#pending'">
                        <div class="icon" id="icon-pending">‚è≥</div>
                        <div class="count" id="total-pending">0</div>
                        <div class="label" id="label-pending">Pending Actions</div>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="dashboard-stats">
                <div class="dashboard-card">
                    <h3>Pending Shipments</h3>
                    <div class="value" id="pending-count">0</div>
                </div>
                <div class="dashboard-card">
                    <h3>In Transit</h3>
                    <div class="value" id="transit-count">0</div>
                </div>
                <div class="dashboard-card">
                    <h3>Delivered (30 days)</h3>
                    <div class="value" id="delivered-count">0</div>
                </div>
                <div class="dashboard-card">
                    <h3>Inventory Items</h3>
                    <div class="value" id="inventory-count">0</div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div style="margin-bottom: var(--spacing-xl);">
                <h2 style="font-size: var(--font-size-xl); margin-bottom: var(--spacing-md); color: var(--color-gray-900);">Quick Actions</h2>
                <div style="display: flex; gap: var(--spacing-sm); flex-wrap: wrap;">
                    <a href="shipments.html" class="btn btn-primary">+ Create Shipment</a>
                    <a href="tracking.html" class="btn btn-outline">Track Package</a>
                    <a href="inventory.html" class="btn btn-outline">View Inventory</a>
                </div>
            </div>

            <!-- Recent Shipments -->
            <div>
                <h2 style="font-size: var(--font-size-xl); margin-bottom: var(--spacing-md); color: var(--color-gray-900);">Recent Shipments</h2>
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Tracking #</th>
                                <th>Destination</th>
                                <th>Status</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="recent-shipments">
                            <tr>
                                <td colspan="4" style="text-align: center; padding: var(--spacing-xl); color: var(--color-gray-500);">
                                    No shipments yet. <a href="shipments.html" style="color: var(--color-accent);">Create your first shipment</a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK - v10 EMAIL CHECK -->
    <script type="module">
        console.log('DASHBOARD v10 - EMAIL-BASED ADMIN CHECK');
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, where, orderBy, limit, getDocs, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA4wMm8-QmZGt3lJcZgTpbBa1W_TklrmRg",
            authDomain: "miamialliance3pl.firebaseapp.com",
            projectId: "miamialliance3pl",
            storageBucket: "miamialliance3pl.firebasestorage.app",
            messagingSenderId: "657614666588",
            appId: "1:657614666588:web:20e50484fe5d90b5aa5f99",
            measurementId: "G-QSRV99D8BX"
        };

        // Admin emails
        const ADMIN_EMAILS = ['ceo@usglatam.com', 'yuri@megalopolisms.com'];

        // The Chosen Ones
        const JORGE_EMAILS = ['ceo@usglatam.com', 'yuri@megalopolisms.com'];
        const JORGE_QUOTES = [
            '"Do or do not ship. There is no try." - Master Yoda, Logistics Division',
            '"I find your lack of tracking numbers disturbing." - Darth Vader',
            '"May the freight be with you." - Obi-Wan Kenobi',
            '"It\'s over Anakin! I have the high ground shipping rates!" - Obi-Wan',
            '"This is the way... to your warehouse." - The Mandalorian',
            '"I am your shipper." - Darth Vader',
            '"These aren\'t the packages you\'re looking for." - Obi-Wan',
            '"The Force is strong with this shipment." - Yoda',
            '"Help me Miami Alliance 3PL, you\'re my only hope." - Princess Leia',
            '"Punch it, Chewie! We got a delivery to make!" - Han Solo'
        ];

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let isAdmin = false;

        // Check authentication
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = '../login.html';
                return;
            }

            let userName = user.displayName || user.email;

            // Try to get user name from Firestore (optional)
            try {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists() && userDoc.data().name) {
                    userName = userDoc.data().name;
                }
            } catch (e) {
                console.log('Could not fetch user doc:', e);
            }

            // Check admin by EMAIL (not UID) - works for both Google and email/password login
            const userEmail = user.email.toLowerCase();
            const emailIsAdmin = ADMIN_EMAILS.map(e => e.toLowerCase()).includes(userEmail);
            const emailIsJorge = JORGE_EMAILS.map(e => e.toLowerCase()).includes(userEmail);

            // DEBUG - show on page permanently
            document.body.insertAdjacentHTML('afterbegin', '<div style="background:red;color:white;padding:20px;font-size:18px;position:fixed;top:0;left:0;right:0;z-index:99999;">DEBUG v12 | Email: ' + userEmail + ' | isAdmin: ' + emailIsAdmin + ' | isJorge: ' + emailIsJorge + '</div>');

            // Set admin status based on email list
            isAdmin = emailIsAdmin;
            const isJorge = emailIsJorge;

            // Update welcome message
            const welcomeTitle = document.getElementById('welcome-title');
            const welcomeSubtitle = document.getElementById('welcome-subtitle');
            const userNameEl = document.getElementById('user-name');


            if (isJorge) {
                welcomeTitle.innerHTML = `Welcome back, Jedi Master ${userName}! ‚öîÔ∏è <span class="admin-badge">SITH LORD</span>`;
                welcomeSubtitle.textContent = "The Force is strong with you. Your galactic logistics empire awaits.";
                userNameEl.innerHTML = `${userName} <span class="admin-badge">üåü JEDI</span>`;

                // Show random Star Wars quote
                const quoteEl = document.getElementById('jorge-quote');
                quoteEl.textContent = JORGE_QUOTES[Math.floor(Math.random() * JORGE_QUOTES.length)];
                quoteEl.style.display = 'block';

                // Jorge gets admin powers too (he IS the Senate)
                document.getElementById('admin-section').style.display = 'block';
                document.getElementById('admin-nav').style.display = 'block';
                document.getElementById('admin-title').innerHTML = '‚öîÔ∏è Galactic Command Center';
                document.getElementById('admin-subtitle').textContent = 'Execute Order 66... or just manage some shipments. Your call, my lord.';

                // Star Wars themed labels for The Chosen One
                document.getElementById('label-users').textContent = 'Rebel Allies';
                document.getElementById('label-shipments').textContent = 'Cargo Runs';
                document.getElementById('icon-shipments').textContent = 'üöÄ';
                document.getElementById('label-inventory').textContent = 'Kyber Crystals';
                document.getElementById('icon-inventory').textContent = 'üíé';
                document.getElementById('label-pending').textContent = 'Missions Pending';
                document.getElementById('icon-pending').textContent = 'üéØ';

                loadAdminStats();
            } else if (isAdmin) {
                welcomeTitle.innerHTML = `Welcome back, ${userName}! <span class="admin-badge">ADMIN</span>`;
                welcomeSubtitle.textContent = "You have full admin access to manage all customers and operations.";
                userNameEl.innerHTML = `${userName} <span class="admin-badge">ADMIN</span>`;

                // Show admin sections
                document.getElementById('admin-section').style.display = 'block';
                document.getElementById('admin-nav').style.display = 'block';

                // Load admin stats
                loadAdminStats();
            } else {
                welcomeTitle.textContent = `Welcome back, ${userName}!`;
                userNameEl.textContent = `Welcome, ${userName}`;
            }

            // Load dashboard data
            loadDashboardData(user.uid);
        });

        // Logout handler
        document.getElementById('logout-btn').addEventListener('click', async (e) => {
            e.preventDefault();
            await signOut(auth);
            window.location.href = '../login.html';
        });

        async function loadAdminStats() {
            try {
                // Total users
                const usersSnap = await getDocs(collection(db, 'users'));
                document.getElementById('total-users').textContent = usersSnap.size;

                // Total shipments
                const shipmentsSnap = await getDocs(collection(db, 'shipments'));
                document.getElementById('total-shipments').textContent = shipmentsSnap.size;

                // Total inventory
                const inventorySnap = await getDocs(collection(db, 'inventory'));
                document.getElementById('total-inventory').textContent = inventorySnap.size;

                // Pending shipments (all)
                const pendingQuery = query(collection(db, 'shipments'), where('status', '==', 'pending'));
                const pendingSnap = await getDocs(pendingQuery);
                document.getElementById('total-pending').textContent = pendingSnap.size;

            } catch (error) {
                console.error('Error loading admin stats:', error);
            }
        }

        async function loadDashboardData(userId) {
            try {
                const shipmentsRef = collection(db, 'shipments');

                if (isAdmin) {
                    // Admins see all shipments
                    const pendingQuery = query(shipmentsRef, where('status', '==', 'pending'));
                    const pendingSnap = await getDocs(pendingQuery);
                    document.getElementById('pending-count').textContent = pendingSnap.size;

                    const transitQuery = query(shipmentsRef, where('status', '==', 'in_transit'));
                    const transitSnap = await getDocs(transitQuery);
                    document.getElementById('transit-count').textContent = transitSnap.size;

                    const deliveredQuery = query(shipmentsRef, where('status', '==', 'delivered'));
                    const deliveredSnap = await getDocs(deliveredQuery);
                    document.getElementById('delivered-count').textContent = deliveredSnap.size;

                    const inventorySnap = await getDocs(collection(db, 'inventory'));
                    document.getElementById('inventory-count').textContent = inventorySnap.size;

                    // Recent shipments (all)
                    const recentQuery = query(shipmentsRef, orderBy('created_at', 'desc'), limit(5));
                    const recentSnap = await getDocs(recentQuery);
                    displayRecentShipments(recentSnap);

                } else {
                    // Regular users see only their shipments
                    const pendingQuery = query(shipmentsRef, where('user_id', '==', userId), where('status', '==', 'pending'));
                    const pendingSnap = await getDocs(pendingQuery);
                    document.getElementById('pending-count').textContent = pendingSnap.size;

                    const transitQuery = query(shipmentsRef, where('user_id', '==', userId), where('status', '==', 'in_transit'));
                    const transitSnap = await getDocs(transitQuery);
                    document.getElementById('transit-count').textContent = transitSnap.size;

                    const deliveredQuery = query(shipmentsRef, where('user_id', '==', userId), where('status', '==', 'delivered'));
                    const deliveredSnap = await getDocs(deliveredQuery);
                    document.getElementById('delivered-count').textContent = deliveredSnap.size;

                    const inventoryQuery = query(collection(db, 'inventory'), where('user_id', '==', userId));
                    const inventorySnap = await getDocs(inventoryQuery);
                    document.getElementById('inventory-count').textContent = inventorySnap.size;

                    // Recent shipments (user's only)
                    const recentQuery = query(shipmentsRef, where('user_id', '==', userId), orderBy('created_at', 'desc'), limit(5));
                    const recentSnap = await getDocs(recentQuery);
                    displayRecentShipments(recentSnap);
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        function displayRecentShipments(snapshot) {
            const tbody = document.getElementById('recent-shipments');
            if (snapshot.size > 0) {
                tbody.innerHTML = '';
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><a href="tracking.html?id=${data.tracking_number}" style="color: var(--color-accent);">${data.tracking_number || 'N/A'}</a></td>
                        <td>${data.destination?.city || 'N/A'}, ${data.destination?.state || ''}</td>
                        <td><span class="badge badge-${data.status}">${(data.status || 'unknown').replace('_', ' ')}</span></td>
                        <td>${data.created_at ? new Date(data.created_at).toLocaleDateString() : 'N/A'}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }
    </script>
    <script src="../js/main.js?v=3"></script>
</body>
</html>
