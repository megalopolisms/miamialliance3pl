<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracking | Miami Alliance 3PL Portal</title>
    <meta name="robots" content="noindex, nofollow">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì¶</text></svg>">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="../css/style.css">
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KTW0F25ZM1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-KTW0F25ZM1');
    </script>
    <script src="../js/analytics.js"></script>
</head>
<body>
    <!-- Navigation -->
    <header class="header">
        <nav class="nav container">
            <a href="../index.html" class="logo">
                <span class="logo-icon">üì¶</span>
                <span class="logo-text">MIAMI ALLIANCE <span class="logo-accent">3PL</span></span>
            </a>
            <button class="nav-toggle sidebar-toggle" aria-label="Toggle sidebar">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <ul class="nav-menu">
                <li><span id="user-name" class="nav-link">Welcome</span></li>
                <li><a href="#" id="logout-btn" class="nav-link btn btn-outline" data-i18n="portal.sidebar.logout">Logout</a></li>
            </ul>
        </nav>
    </header>

    <div class="portal-layout">
        <!-- Sidebar -->
        <aside class="portal-sidebar">
            <nav role="navigation" aria-label="Main navigation">
                <a href="dashboard.html" class="portal-nav-item">
                    <span aria-hidden="true">üìä</span> <span data-i18n="portal.sidebar.dashboard">Dashboard</span>
                </a>
                <a href="shipments.html" class="portal-nav-item">
                    <span aria-hidden="true">üöö</span> <span data-i18n="portal.sidebar.shipments">Shipments</span>
                </a>
                <a href="tracking.html" class="portal-nav-item active" aria-current="page">
                    <span aria-hidden="true">üîç</span> <span data-i18n="portal.sidebar.tracking">Tracking</span>
                </a>
                <a href="inventory.html" class="portal-nav-item">
                    <span aria-hidden="true">üì¶</span> <span data-i18n="portal.sidebar.inventory">Inventory</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="portal-main">
            <h1 style="margin-bottom: var(--spacing-lg); color: var(--color-gray-900);" data-i18n="portal.tracking.title">Track Shipment</h1>

            <!-- Search Form -->
            <div class="dashboard-card" style="margin-bottom: var(--spacing-xl);">
                <form id="tracking-form" style="display: flex; gap: var(--spacing-sm); flex-wrap: wrap;" role="search" aria-label="Track shipment">
                    <label for="tracking-input" class="visually-hidden">Tracking number</label>
                    <input type="text" id="tracking-input" placeholder="Enter tracking number (e.g., MA3PL12345678)" data-i18n-placeholder="portal.tracking.inputPh" style="flex: 1; min-width: 250px; padding: 0.75rem 1rem; border: 1px solid var(--color-gray-300); border-radius: var(--radius-md); font-size: var(--font-size-base);" aria-required="true">
                    <button type="submit" class="btn btn-primary" data-i18n="portal.tracking.trackBtn">Track</button>
                </form>
            </div>

            <!-- Tracking Result -->
            <div id="tracking-result" style="display: none;" aria-live="polite">
                <div class="dashboard-card" style="margin-bottom: var(--spacing-lg);">
                    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: var(--spacing-md);">
                        <div>
                            <h2 style="font-size: var(--font-size-xl); color: var(--color-gray-900); margin-bottom: var(--spacing-xs);"><span data-i18n="portal.tracking.trackingHash">Tracking #</span> <span id="result-tracking"></span></h2>
                            <p style="color: var(--color-gray-500);"><span data-i18n="portal.tracking.created">Created:</span> <span id="result-date"></span></p>
                        </div>
                        <span id="result-status" class="badge"></span>
                    </div>
                </div>

                <!-- Shipment Details -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                    <div class="dashboard-card">
                        <h3 style="font-size: var(--font-size-base); color: var(--color-gray-500); margin-bottom: var(--spacing-sm);" data-i18n="portal.tracking.origin">Origin</h3>
                        <p id="result-origin" style="color: var(--color-gray-900);"></p>
                    </div>
                    <div class="dashboard-card">
                        <h3 style="font-size: var(--font-size-base); color: var(--color-gray-500); margin-bottom: var(--spacing-sm);" data-i18n="portal.tracking.destination">Destination</h3>
                        <p id="result-destination" style="color: var(--color-gray-900);"></p>
                    </div>
                    <div class="dashboard-card">
                        <h3 style="font-size: var(--font-size-base); color: var(--color-gray-500); margin-bottom: var(--spacing-sm);" data-i18n="portal.tracking.packageDetails">Package Details</h3>
                        <p id="result-package" style="color: var(--color-gray-900);"></p>
                    </div>
                    <div class="dashboard-card">
                        <h3 style="font-size: var(--font-size-base); color: var(--color-gray-500); margin-bottom: var(--spacing-sm);" data-i18n="portal.tracking.service">Service</h3>
                        <p id="result-service" style="color: var(--color-gray-900); text-transform: capitalize;"></p>
                    </div>
                </div>

                <!-- BOL / Document Info (shown if document is attached) -->
                <div id="document-info" style="display: none; margin-bottom: var(--spacing-lg);">
                    <div class="dashboard-card" style="border-left: 4px solid #14b8a6;">
                        <h3 style="font-size: var(--font-size-base); color: var(--color-gray-500); margin-bottom: var(--spacing-sm);">üìã Attached Document</h3>
                        <div id="document-details" style="color: var(--color-gray-900);"></div>
                        <a id="document-download" href="#" target="_blank" style="display:none; margin-top: var(--spacing-sm); color: var(--color-accent); font-weight: 500; font-size: var(--font-size-sm);">üì• View / Download Document</a>
                    </div>
                </div>

                <!-- Timeline -->
                <div class="dashboard-card">
                    <h3 style="font-size: var(--font-size-lg); color: var(--color-gray-900); margin-bottom: var(--spacing-md);" data-i18n="portal.tracking.history">Tracking History</h3>
                    <div id="tracking-timeline" style="border-left: 2px solid var(--color-gray-200); padding-left: var(--spacing-md); margin-left: var(--spacing-xs);">
                        <!-- Timeline items will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- No Result -->
            <div id="no-result" style="display: none;" class="dashboard-card" role="alert" aria-live="polite">
                <div style="text-align: center; padding: var(--spacing-xl);">
                    <div style="font-size: 3rem; margin-bottom: var(--spacing-sm);">üîç</div>
                    <h3 style="color: var(--color-gray-900); margin-bottom: var(--spacing-xs);" data-i18n="portal.tracking.notFound">Shipment Not Found</h3>
                    <p style="color: var(--color-gray-500);" data-i18n="portal.tracking.notFoundDesc">Please check the tracking number and try again.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- i18n -->
    <script src="../js/lang/es.js"></script>
    <script src="../js/i18n.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, where, getDocs, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyA4wMm8-QmZGt3lJcZgTpbBa1W_TklrmRg",
            authDomain: "miamialliance3pl.firebaseapp.com",
            projectId: "miamialliance3pl",
            storageBucket: "miamialliance3pl.firebasestorage.app",
            messagingSenderId: "657614666588",
            appId: "1:657614666588:web:20e50484fe5d90b5aa5f99",
            measurementId: "G-KTW0F25ZM1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Fallback admin emails (used only if Firestore role check fails)
        const FALLBACK_ADMIN_EMAILS = [
            'ceo@usglatam.com',
            'yuri@megalopolisms.com',
            'admin@miamialliance3pl.com',
            'operations@miamialliance3pl.com'
        ];

        // Current user data
        let currentUser = null;
        let currentUserRole = null;
        let currentUserEmail = null;

        // Check if user is staff (admin or employee)
        function isStaff() {
            return currentUserRole === 'admin' || currentUserRole === 'employee';
        }

        // Check authentication and get user role from Firestore
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = '../login.html';
                return;
            }

            currentUser = user;
            currentUserEmail = user.email;

            // Get user role from Firestore users collection
            try {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    document.getElementById('user-name').textContent = 'Welcome, ' + userData.name;
                    currentUserRole = userData.role || 'customer';
                } else {
                    // Fallback: check if email is in fallback admin list
                    if (FALLBACK_ADMIN_EMAILS.includes(user.email)) {
                        currentUserRole = 'admin';
                    } else {
                        currentUserRole = 'customer';
                    }
                }
            } catch (error) {
                console.error('Error fetching user role:', error);
                // Fallback: check if email is in fallback admin list
                if (FALLBACK_ADMIN_EMAILS.includes(user.email)) {
                    currentUserRole = 'admin';
                } else {
                    currentUserRole = 'customer';
                }
            }

            // Check for URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const trackingId = urlParams.get('id');
            if (trackingId) {
                document.getElementById('tracking-input').value = trackingId;
                trackShipment(trackingId);
            }
        });

        // Logout handler
        document.getElementById('logout-btn').addEventListener('click', async (e) => {
            e.preventDefault();
            await signOut(auth);
            window.location.href = '../login.html';
        });

        // Track form submission
        document.getElementById('tracking-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const trackingNumber = document.getElementById('tracking-input').value.trim();
            if (trackingNumber) {
                trackShipment(trackingNumber);
            }
        });

        async function trackShipment(trackingNumber) {
            document.getElementById('tracking-result').style.display = 'none';
            document.getElementById('no-result').style.display = 'none';

            try {
                const q = query(
                    collection(db, 'shipments'),
                    where('tracking_number', '==', trackingNumber)
                );
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    document.getElementById('no-result').style.display = 'block';
                    return;
                }

                const shipmentData = snapshot.docs[0].data();

                // Role-based access control:
                // Staff (admin/employee) can track any shipment
                // Customers can only track their own shipments
                if (!isStaff()) {
                    // Customer: verify they own this shipment
                    const isOwner = shipmentData.user_id === currentUser.uid ||
                                    shipmentData.customer_email === currentUserEmail ||
                                    shipmentData.created_by === currentUser.uid;

                    if (!isOwner) {
                        document.getElementById('no-result').style.display = 'block';
                        return;
                    }
                }

                displayShipment(shipmentData);
            } catch (error) {
                console.error('Error tracking shipment:', error);
                document.getElementById('no-result').style.display = 'block';
            }
        }

        function displayShipment(data) {
            document.getElementById('tracking-result').style.display = 'block';

            document.getElementById('result-tracking').textContent = data.tracking_number;
            document.getElementById('result-date').textContent = new Date(data.created_at).toLocaleString();

            const statusEl = document.getElementById('result-status');
            statusEl.className = 'badge badge-' + data.status;
            statusEl.textContent = data.status.replace('_', ' ');

            document.getElementById('result-origin').innerHTML = `
                ${data.origin.street}<br>
                ${data.origin.city}, ${data.origin.state} ${data.origin.zip}
            `;

            document.getElementById('result-destination').innerHTML = `
                ${data.destination.name}<br>
                ${data.destination.street}<br>
                ${data.destination.city}, ${data.destination.state} ${data.destination.zip}
            `;

            document.getElementById('result-package').innerHTML = `
                Weight: ${data.package.weight} lbs<br>
                Dimensions: ${data.package.length || '-'}√ó${data.package.width || '-'}√ó${data.package.height || '-'} in<br>
                Quantity: ${data.package.quantity}
            `;

            document.getElementById('result-service').textContent = data.service_type || data.shipping_zone || '';

            // Show BOL / Document info if present
            const docInfoEl = document.getElementById('document-info');
            const docDetailsEl = document.getElementById('document-details');
            const docDownloadEl = document.getElementById('document-download');

            if (data.bol_document) {
                docInfoEl.style.display = 'block';
                let docHTML = '';
                const bd = data.bol_document;
                const pdata = bd.parsed_data || {};

                const docTypeLabel = bd.type === 'bol' ? 'Bill of Lading' : bd.type === 'shipping_label' ? 'Shipping Label' : 'Document';
                docHTML += '<strong>Type:</strong> ' + docTypeLabel + '<br>';
                docHTML += '<strong>File:</strong> ' + (bd.file_name || 'Unknown') + ' (' + formatDocSize(bd.file_size) + ')<br>';

                if (data.carrier_name) docHTML += '<strong>Carrier:</strong> ' + data.carrier_name + '<br>';
                if (data.carrier_tracking) docHTML += '<strong>Carrier Tracking:</strong> <code style="background:#f0fdfa;padding:2px 6px;border-radius:4px;color:#14b8a6;">' + data.carrier_tracking + '</code><br>';
                if (data.bol_number) docHTML += '<strong>BOL #:</strong> ' + data.bol_number + '<br>';
                if (data.pro_number) docHTML += '<strong>PRO #:</strong> ' + data.pro_number + '<br>';
                if (pdata.weight) docHTML += '<strong>Weight (from doc):</strong> ' + pdata.weight + '<br>';
                if (pdata.pieces) docHTML += '<strong>Pieces (from doc):</strong> ' + pdata.pieces + '<br>';
                if (pdata.ship_from) docHTML += '<strong>Ship From (from doc):</strong> ' + pdata.ship_from + '<br>';

                docDetailsEl.innerHTML = docHTML;

                if (bd.file_url) {
                    docDownloadEl.style.display = 'inline-block';
                    docDownloadEl.href = bd.file_url;
                } else {
                    docDownloadEl.style.display = 'none';
                }
            } else {
                docInfoEl.style.display = 'none';
            }

            // Generate timeline
            const timeline = document.getElementById('tracking-timeline');
            timeline.innerHTML = '';

            const statuses = [
                { status: 'pending', label: 'Order Created', icon: 'üìù' },
                { status: 'picked_up', label: 'Picked Up', icon: 'üì¶' },
                { status: 'in_transit', label: 'In Transit', icon: 'üöö' },
                { status: 'delivered', label: 'Delivered', icon: '‚úÖ' }
            ];

            const currentIndex = statuses.findIndex(s => s.status === data.status);

            statuses.forEach((s, index) => {
                const isCompleted = index <= currentIndex;
                const isCurrent = index === currentIndex;

                const item = document.createElement('div');
                item.style.cssText = `
                    position: relative;
                    padding-bottom: var(--spacing-md);
                    margin-left: -24px;
                `;

                item.innerHTML = `
                    <div style="
                        position: absolute;
                        left: 0;
                        width: 12px;
                        height: 12px;
                        border-radius: 50%;
                        background: ${isCompleted ? 'var(--color-accent)' : 'var(--color-gray-300)'};
                        transform: translateX(-5px);
                    "></div>
                    <div style="margin-left: 24px;">
                        <div style="display: flex; align-items: center; gap: var(--spacing-xs);">
                            <span>${s.icon}</span>
                            <strong style="color: ${isCompleted ? 'var(--color-gray-900)' : 'var(--color-gray-400)'};">${s.label}</strong>
                        </div>
                        ${isCurrent ? `<p style="font-size: var(--font-size-sm); color: var(--color-gray-500); margin-top: 2px;">${new Date(data.updated_at).toLocaleString()}</p>` : ''}
                    </div>
                `;

                timeline.appendChild(item);
            });

            // Show custom tracking events (document uploads, status changes, etc.)
            if (data.tracking_events && Array.isArray(data.tracking_events)) {
                const eventsHeader = document.createElement('div');
                eventsHeader.style.cssText = 'margin-top: var(--spacing-lg); padding-top: var(--spacing-md); border-top: 1px solid var(--color-gray-200);';
                eventsHeader.innerHTML = '<h4 style="font-size: var(--font-size-sm); color: var(--color-gray-500); margin-bottom: var(--spacing-sm);">Activity Log</h4>';
                timeline.appendChild(eventsHeader);

                data.tracking_events.forEach(evt => {
                    const evtItem = document.createElement('div');
                    evtItem.style.cssText = 'position: relative; padding-bottom: 10px; margin-left: -24px;';
                    const evtIcon = evt.event === 'document_uploaded' ? 'üìã' : evt.event === 'shipment_created' ? '‚ú®' : evt.event === 'status_updated' ? 'üîÑ' : 'üìå';
                    evtItem.innerHTML = `
                        <div style="position: absolute; left: 0; width: 8px; height: 8px; border-radius: 50%; background: #14b8a6; transform: translateX(-3px); margin-top: 4px;"></div>
                        <div style="margin-left: 24px;">
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <span style="font-size: 0.85rem;">${evtIcon}</span>
                                <span style="font-size: var(--font-size-sm); color: var(--color-gray-900);">${evt.details || evt.event}</span>
                            </div>
                            <p style="font-size: 0.72rem; color: var(--color-gray-400); margin-top: 1px;">${new Date(evt.timestamp).toLocaleString()}</p>
                            ${evt.file_name ? '<p style="font-size: 0.72rem; color: var(--color-gray-500);">File: ' + evt.file_name + '</p>' : ''}
                        </div>
                    `;
                    timeline.appendChild(evtItem);
                });
            }
        }

        function formatDocSize(bytes) {
            if (!bytes) return '';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
    </script>
    <script src="../js/main.js"></script>
</body>
</html>
