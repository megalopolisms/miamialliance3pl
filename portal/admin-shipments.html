<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Shipments | Miami Alliance 3PL Admin</title>
    <meta name="robots" content="noindex, nofollow">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì¶</text></svg>">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="../css/style.css?v=202602230220">
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QSRV99D8BX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-QSRV99D8BX');
    </script>
    <script src="../js/analytics.js"></script>
    <style>
        .admin-badge {
            background: linear-gradient(135deg, #f97316, #ea580c);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }
        .page-header-bar {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            color: white;
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-xl);
        }
        .page-header-bar h1 {
            font-size: var(--font-size-2xl);
            margin-bottom: var(--spacing-xs);
        }
        .filters-bar {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
        }
        .filters-bar input, .filters-bar select {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--color-gray-300);
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
        }
        .filters-bar input {
            flex: 1;
            min-width: 200px;
        }
        .shipment-card {
            background: white;
            border: 1px solid var(--color-gray-200);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            transition: box-shadow 0.2s;
        }
        .shipment-card:hover {
            box-shadow: var(--shadow-lg);
        }
        .shipment-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-md);
            flex-wrap: wrap;
            gap: var(--spacing-sm);
        }
        .tracking-number {
            font-size: var(--font-size-lg);
            font-weight: 700;
            color: var(--color-accent);
            font-family: monospace;
        }
        .shipment-customer {
            font-size: var(--font-size-sm);
            color: var(--color-gray-600);
        }
        .shipment-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }
        .detail-group h4 {
            font-size: var(--font-size-xs);
            color: var(--color-gray-500);
            text-transform: uppercase;
            margin-bottom: var(--spacing-xs);
        }
        .detail-group p {
            color: var(--color-gray-900);
        }
        .shipment-actions {
            display: flex;
            gap: var(--spacing-sm);
            padding-top: var(--spacing-md);
            border-top: 1px solid var(--color-gray-200);
            align-items: center;
            flex-wrap: wrap;
        }
        .status-select {
            padding: 8px 12px;
            border: 2px solid var(--color-accent);
            border-radius: var(--radius-md);
            font-weight: 600;
            background: white;
            cursor: pointer;
        }
        .status-select:focus {
            outline: none;
            border-color: var(--color-primary);
        }
        .btn-update {
            background: var(--color-accent);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-update:hover {
            background: var(--color-accent-hover);
        }
        .btn-update:disabled {
            background: var(--color-gray-300);
            cursor: not-allowed;
        }
        .update-success {
            color: #16a34a;
            font-weight: 500;
            display: none;
        }
        .empty-state {
            text-align: center;
            padding: var(--spacing-2xl);
            color: var(--color-gray-500);
        }
        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: var(--spacing-md);
        }
        .package-info {
            background: var(--color-gray-100);
            padding: var(--spacing-sm);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
        }

        /* Toast notification styles */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            background: #1e3a5f;
            color: white;
            padding: 16px 24px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
            min-width: 280px;
        }
        .toast.success {
            background: linear-gradient(135deg, #16a34a, #15803d);
        }
        .toast.error {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }
        .toast.warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        .toast-icon {
            font-size: 1.25rem;
        }
        .toast-message {
            flex: 1;
            font-weight: 500;
        }
        .toast-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.25rem;
            opacity: 0.7;
        }
        .toast-close:hover {
            opacity: 1;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Status badge colors */
        .badge-pending {
            background: #fef3c7;
            color: #92400e;
        }
        .badge-processing {
            background: #dbeafe;
            color: #1e40af;
        }
        .badge-picked_up {
            background: #e0e7ff;
            color: #3730a3;
        }
        .badge-in_transit {
            background: #cffafe;
            color: #0e7490;
        }
        .badge-out_for_delivery {
            background: #d1fae5;
            color: #065f46;
        }
        .badge-delivered {
            background: #dcfce7;
            color: #166534;
        }
        .badge-cancelled {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Update button styling */
        .btn-update-status {
            background: linear-gradient(135deg, var(--color-accent), #ea580c);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .btn-update-status:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }
        .btn-update-status:disabled {
            background: var(--color-gray-300);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn-update-status.loading {
            pointer-events: none;
        }
        .btn-update-status .spinner {
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal h2 {
            margin-bottom: var(--spacing-md);
        }
        .modal .form-group {
            margin-bottom: var(--spacing-md);
        }
        .modal-actions {
            display: flex;
            gap: var(--spacing-sm);
            justify-content: flex-end;
            margin-top: var(--spacing-lg);
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Navigation -->
    <header class="header">
        <nav class="nav container">
            <a href="../index.html" class="logo">
                <span class="logo-text">MIAMI ALLIANCE <span class="logo-accent">3PL</span></span>
            </a>
            <button class="nav-toggle sidebar-toggle" aria-label="Toggle sidebar">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <ul class="nav-menu">
                <li><span id="user-name" class="nav-link">Welcome</span></li>
                <li><a href="#" id="logout-btn" class="nav-link btn btn-outline">Logout</a></li>
            </ul>
        </nav>
    </header>

    <div class="portal-layout">
        <!-- Sidebar -->
        <aside class="portal-sidebar">
            <nav>
                <a href="dashboard.html" class="portal-nav-item">
                    <span>üìä</span> Dashboard
                </a>
                <a href="shipments.html" class="portal-nav-item">
                    <span>üöö</span> Shipments
                </a>
                <a href="tracking.html" class="portal-nav-item">
                    <span>üîç</span> Tracking
                </a>
                <a href="inventory.html" class="portal-nav-item">
                    <span>üì¶</span> Inventory
                </a>
                <div id="admin-nav" style="display: none; margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--color-gray-200);">
                    <div style="padding: 8px 16px; font-size: 0.75rem; color: var(--color-gray-500); text-transform: uppercase;">Admin</div>
                    <a href="pricing.html" class="portal-nav-item">
                        <span>üí∞</span> Pricing
                    </a>
                    <a href="settings.html" class="portal-nav-item">
                        <span>‚öôÔ∏è</span> Settings
                    </a>
                    <a href="team.html" class="portal-nav-item">
                        <span>üëî</span> Manage Team
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="portal-main">
            <!-- Page Header -->
            <div class="page-header-bar">
                <h1 id="page-title">üìã All Shipments</h1>
                <p>View and manage shipments from all customers</p>
            </div>

            <!-- Filters Bar -->
            <div class="filters-bar">
                <input type="text" id="search-input" placeholder="Search tracking #, customer, destination...">
                <select id="status-filter">
                    <option value="">All Statuses</option>
                    <option value="pending">Pending</option>
                    <option value="processing">Processing</option>
                    <option value="picked_up">Picked Up</option>
                    <option value="in_transit">In Transit</option>
                    <option value="out_for_delivery">Out for Delivery</option>
                    <option value="delivered">Delivered</option>
                    <option value="cancelled">Cancelled</option>
                </select>
                <button class="btn btn-primary" onclick="applyFilters()">Filter</button>
                <button class="btn btn-outline" onclick="clearFilters()">Clear</button>
            </div>

            <!-- Stats Summary -->
            <div class="dashboard-stats" style="margin-bottom: var(--spacing-xl);">
                <div class="dashboard-card">
                    <h3>Total Shipments</h3>
                    <div class="value" id="total-shipments">0</div>
                </div>
                <div class="dashboard-card">
                    <h3>Pending</h3>
                    <div class="value" id="pending-shipments">0</div>
                </div>
                <div class="dashboard-card">
                    <h3>In Transit</h3>
                    <div class="value" id="transit-shipments">0</div>
                </div>
                <div class="dashboard-card">
                    <h3>Delivered</h3>
                    <div class="value" id="delivered-shipments">0</div>
                </div>
            </div>

            <!-- Shipments List -->
            <div id="shipments-list">
                <div class="empty-state">
                    <div class="icon">‚è≥</div>
                    <p>Loading shipments...</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Edit Modal -->
    <div class="modal-overlay" id="edit-modal">
        <div class="modal">
            <h2>üìù Edit Shipment</h2>
            <form id="edit-form">
                <input type="hidden" id="edit-shipment-id">
                <div class="form-group">
                    <label>Tracking Number</label>
                    <input type="text" id="edit-tracking" readonly style="background: var(--color-gray-100);">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="edit-status">
                        <option value="pending">Pending</option>
                        <option value="processing">Processing</option>
                        <option value="picked_up">Picked Up</option>
                        <option value="in_transit">In Transit</option>
                        <option value="out_for_delivery">Out for Delivery</option>
                        <option value="delivered">Delivered</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Admin Notes</label>
                    <textarea id="edit-notes" rows="3" placeholder="Internal notes about this shipment..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, where, orderBy, getDocs, doc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA4wMm8-QmZGt3lJcZgTpbBa1W_TklrmRg",
            authDomain: "miamialliance3pl.firebaseapp.com",
            projectId: "miamialliance3pl",
            storageBucket: "miamialliance3pl.firebasestorage.app",
            messagingSenderId: "657614666588",
            appId: "1:657614666588:web:20e50484fe5d90b5aa5f99",
            measurementId: "G-QSRV99D8BX"
        };

        // Fallback admin emails (used when no Firestore role exists)
        const FALLBACK_ADMIN_EMAILS = ['ceo@usglatam.com', 'yuri@megalopolisms.com'];

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allShipments = [];
        let usersMap = {};

        // Check authentication and role
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = '../login.html';
                return;
            }

            let userName = user.displayName || user.email;
            const userEmail = user.email.toLowerCase();

            // Check user role from Firestore
            let userRole = null;
            let isStaff = false;

            try {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    userRole = userData.role;
                }
            } catch (error) {
                console.error('Error fetching user role:', error);
            }

            // Determine if user is staff (admin or employee)
            if (userRole === 'admin' || userRole === 'employee') {
                isStaff = true;
            } else if (!userRole) {
                // Fallback: check against fallback admin emails if no Firestore role exists
                isStaff = FALLBACK_ADMIN_EMAILS.map(e => e.toLowerCase()).includes(userEmail);
            }

            // Redirect non-staff users to dashboard
            if (!isStaff) {
                window.location.href = 'dashboard.html';
                return;
            }

            // Display appropriate badge based on role
            const userNameEl = document.getElementById('user-name');
            if (userRole === 'admin') {
                userNameEl.innerHTML = `${userName} <span class="admin-badge">ADMIN</span>`;
            } else if (userRole === 'employee') {
                userNameEl.innerHTML = `${userName} <span class="admin-badge">STAFF</span>`;
            } else {
                // Fallback admin (no Firestore role but in fallback list)
                userNameEl.innerHTML = `${userName} <span class="admin-badge">ADMIN</span>`;
            }

            await loadUsers();
            loadShipments();
        });

        // Logout handler
        document.getElementById('logout-btn').addEventListener('click', async (e) => {
            e.preventDefault();
            await signOut(auth);
            window.location.href = '../login.html';
        });

        async function loadUsers() {
            const usersSnap = await getDocs(collection(db, 'users'));
            usersSnap.forEach((doc) => {
                usersMap[doc.id] = doc.data();
            });
        }

        async function loadShipments() {
            try {
                const shipmentsRef = collection(db, 'shipments');
                const shipmentsSnap = await getDocs(shipmentsRef);

                allShipments = [];
                let pending = 0, transit = 0, delivered = 0;

                shipmentsSnap.forEach((doc) => {
                    const data = { id: doc.id, ...doc.data() };
                    allShipments.push(data);

                    if (data.status === 'pending') pending++;
                    if (data.status === 'in_transit' || data.status === 'picked_up' || data.status === 'out_for_delivery') transit++;
                    if (data.status === 'delivered') delivered++;
                });

                // Update stats
                document.getElementById('total-shipments').textContent = allShipments.length;
                document.getElementById('pending-shipments').textContent = pending;
                document.getElementById('transit-shipments').textContent = transit;
                document.getElementById('delivered-shipments').textContent = delivered;

                // Display shipments
                displayShipments(allShipments);

            } catch (error) {
                console.error('Error loading shipments:', error);
                document.getElementById('shipments-list').innerHTML = `
                    <div class="empty-state">
                        <div class="icon">‚ùå</div>
                        <p>Error loading shipments: ${error.message}</p>
                    </div>
                `;
            }
        }

        function displayShipments(shipments) {
            const container = document.getElementById('shipments-list');

            if (shipments.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üì¶</div>
                        <p>No shipments found</p>
                    </div>
                `;
                return;
            }

            // Sort by created_at descending
            shipments.sort((a, b) => {
                const dateA = a.created_at ? new Date(a.created_at) : new Date(0);
                const dateB = b.created_at ? new Date(b.created_at) : new Date(0);
                return dateB - dateA;
            });

            container.innerHTML = shipments.map(shipment => {
                const customer = usersMap[shipment.user_id] || {};
                const origin = shipment.origin || {};
                const destination = shipment.destination || {};

                return `
                <div class="shipment-card" data-id="${shipment.id}">
                    <div class="shipment-header">
                        <div>
                            <div class="tracking-number">${shipment.tracking_number || 'No tracking #'}</div>
                            <div class="shipment-customer">
                                üë§ ${customer.name || customer.email || 'Unknown Customer'}
                                ${customer.company_name ? `‚Ä¢ ${customer.company_name}` : ''}
                            </div>
                        </div>
                        <span class="badge badge-${shipment.status}" id="badge-${shipment.id}">${formatStatus(shipment.status || 'unknown')}</span>
                    </div>

                    <div class="shipment-details">
                        <div class="detail-group">
                            <h4>üìç Origin</h4>
                            <p>${origin.address || 'N/A'}<br>${origin.city || ''}, ${origin.state || ''} ${origin.zip || ''}</p>
                        </div>
                        <div class="detail-group">
                            <h4>üéØ Destination</h4>
                            <p>${destination.address || 'N/A'}<br>${destination.city || ''}, ${destination.state || ''} ${destination.zip || ''}</p>
                        </div>
                    </div>

                    <div class="package-info">
                        üì¶ ${shipment.packages?.length || 0} package(s)
                        ‚Ä¢ Created: ${shipment.created_at ? new Date(shipment.created_at).toLocaleDateString() : 'N/A'}
                        ${shipment.admin_notes ? `‚Ä¢ üìù Notes: ${shipment.admin_notes}` : ''}
                    </div>

                    <div class="shipment-actions">
                        <label style="font-weight: 500; margin-right: 8px;">Status:</label>
                        <select class="status-select" id="status-${shipment.id}" data-original="${shipment.status}">
                            <option value="pending" ${shipment.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="processing" ${shipment.status === 'processing' ? 'selected' : ''}>Processing</option>
                            <option value="picked_up" ${shipment.status === 'picked_up' ? 'selected' : ''}>Picked Up</option>
                            <option value="in_transit" ${shipment.status === 'in_transit' ? 'selected' : ''}>In Transit</option>
                            <option value="out_for_delivery" ${shipment.status === 'out_for_delivery' ? 'selected' : ''}>Out for Delivery</option>
                            <option value="delivered" ${shipment.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                            <option value="cancelled" ${shipment.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                        </select>
                        <button class="btn-update-status" id="btn-update-${shipment.id}" onclick="updateShipmentStatus('${shipment.id}')">
                            <span class="btn-text">Update Status</span>
                        </button>
                        <button class="btn btn-outline" style="margin-left: auto;" onclick="openEditModal('${shipment.id}')">‚úèÔ∏è Edit Details</button>
                    </div>
                </div>
            `}).join('');
        }

        // Format status for display
        function formatStatus(status) {
            const statusMap = {
                'pending': 'Pending',
                'processing': 'Processing',
                'picked_up': 'Picked Up',
                'in_transit': 'In Transit',
                'out_for_delivery': 'Out for Delivery',
                'delivered': 'Delivered',
                'cancelled': 'Cancelled'
            };
            return statusMap[status] || status.replace('_', ' ');
        }

        // Toast notification function
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = {
                success: '‚úì',
                error: '‚úï',
                warning: '‚ö†'
            };

            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.success}</span>
                <span class="toast-message">${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;

            container.appendChild(toast);

            // Auto-remove after 4 seconds
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out forwards';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // Update shipment status with button click
        window.updateShipmentStatus = async function(shipmentId) {
            const selectEl = document.getElementById(`status-${shipmentId}`);
            const btnEl = document.getElementById(`btn-update-${shipmentId}`);
            const newStatus = selectEl.value;
            const originalStatus = selectEl.dataset.original;

            // Check if status actually changed
            if (newStatus === originalStatus) {
                showToast('Status unchanged. Select a different status to update.', 'warning');
                return;
            }

            // Show loading state
            btnEl.classList.add('loading');
            btnEl.innerHTML = '<span class="spinner"></span> Updating...';
            btnEl.disabled = true;

            try {
                const shipmentRef = doc(db, 'shipments', shipmentId);
                await updateDoc(shipmentRef, {
                    status: newStatus,
                    updated_at: new Date().toISOString()
                });

                // Update local data
                const shipment = allShipments.find(s => s.id === shipmentId);
                if (shipment) shipment.status = newStatus;

                // Update badge
                const badge = document.getElementById(`badge-${shipmentId}`);
                badge.className = `badge badge-${newStatus}`;
                badge.textContent = formatStatus(newStatus);

                // Update the original status data attribute
                selectEl.dataset.original = newStatus;

                // Show success toast
                showToast(`Status updated to "${formatStatus(newStatus)}" successfully!`, 'success');

                // Update stats
                updateStats();

            } catch (error) {
                console.error('Error updating status:', error);
                showToast('Error updating status: ' + error.message, 'error');
                // Revert select to original value
                selectEl.value = originalStatus;
            } finally {
                // Reset button state
                btnEl.classList.remove('loading');
                btnEl.innerHTML = '<span class="btn-text">Update Status</span>';
                btnEl.disabled = false;
            }
        };

        // Update stats after status change
        function updateStats() {
            let pending = 0, transit = 0, delivered = 0;
            allShipments.forEach(data => {
                if (data.status === 'pending') pending++;
                if (data.status === 'in_transit' || data.status === 'picked_up' || data.status === 'out_for_delivery' || data.status === 'processing') transit++;
                if (data.status === 'delivered') delivered++;
            });
            document.getElementById('total-shipments').textContent = allShipments.length;
            document.getElementById('pending-shipments').textContent = pending;
            document.getElementById('transit-shipments').textContent = transit;
            document.getElementById('delivered-shipments').textContent = delivered;
        }

        // Edit modal functions
        window.openEditModal = function(shipmentId) {
            const shipment = allShipments.find(s => s.id === shipmentId);
            if (!shipment) return;

            document.getElementById('edit-shipment-id').value = shipmentId;
            document.getElementById('edit-tracking').value = shipment.tracking_number || '';
            document.getElementById('edit-status').value = shipment.status || 'pending';
            document.getElementById('edit-notes').value = shipment.admin_notes || '';

            document.getElementById('edit-modal').classList.add('active');
        };

        window.closeModal = function() {
            document.getElementById('edit-modal').classList.remove('active');
        };

        // Edit form submission
        document.getElementById('edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const shipmentId = document.getElementById('edit-shipment-id').value;
            const newStatus = document.getElementById('edit-status').value;
            const adminNotes = document.getElementById('edit-notes').value;
            const submitBtn = e.target.querySelector('button[type="submit"]');

            // Show loading state
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            try {
                const shipmentRef = doc(db, 'shipments', shipmentId);
                await updateDoc(shipmentRef, {
                    status: newStatus,
                    admin_notes: adminNotes,
                    updated_at: new Date().toISOString()
                });

                // Update local data and UI
                const shipment = allShipments.find(s => s.id === shipmentId);
                if (shipment) {
                    shipment.status = newStatus;
                    shipment.admin_notes = adminNotes;
                }

                closeModal();
                displayShipments(allShipments);
                updateStats();

                showToast('Shipment updated successfully!', 'success');
            } catch (error) {
                console.error('Error updating shipment:', error);
                showToast('Error updating shipment: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Changes';
            }
        });

        // Filter functions
        window.applyFilters = function() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;

            let filtered = allShipments;

            if (searchTerm) {
                filtered = filtered.filter(s => {
                    const customer = usersMap[s.user_id] || {};
                    return (s.tracking_number && s.tracking_number.toLowerCase().includes(searchTerm)) ||
                           (customer.name && customer.name.toLowerCase().includes(searchTerm)) ||
                           (customer.email && customer.email.toLowerCase().includes(searchTerm)) ||
                           (s.destination?.city && s.destination.city.toLowerCase().includes(searchTerm));
                });
            }

            if (statusFilter) {
                filtered = filtered.filter(s => s.status === statusFilter);
            }

            displayShipments(filtered);
        };

        window.clearFilters = function() {
            document.getElementById('search-input').value = '';
            document.getElementById('status-filter').value = '';
            displayShipments(allShipments);
        };

        // Search on Enter key
        document.getElementById('search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') applyFilters();
        });

        // Close modal on overlay click
        document.getElementById('edit-modal').addEventListener('click', (e) => {
            if (e.target.id === 'edit-modal') closeModal();
        });
    </script>
    <script src="../js/main.js"></script>
</body>
</html>
