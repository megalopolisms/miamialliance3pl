<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storage Log | Miami Alliance 3PL</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì¶</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css?v=8">
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QSRV99D8BX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-QSRV99D8BX');
    </script>
    <script src="../js/analytics.js"></script>
    <style>
        .page-header-bar {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            color: white;
            padding: var(--spacing-xl);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-xl);
        }
        .snapshot-card {
            background: white;
            border: 1px solid var(--color-gray-200);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }
        .snapshot-card h3 {
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .snapshot-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
        }
        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--color-gray-700);
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--color-gray-300);
            border-radius: var(--radius-md);
        }
        .btn-row {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }
        .history-table {
            width: 100%;
            border-collapse: collapse;
        }
        .history-table th, .history-table td {
            padding: var(--spacing-sm) var(--spacing-md);
            text-align: left;
            border-bottom: 1px solid var(--color-gray-200);
        }
        .history-table th {
            background: var(--color-gray-50);
            font-weight: 600;
        }
        .auto-count-banner {
            background: #ecfdf5;
            border: 1px solid #10b981;
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        .auto-count-banner .count {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: #059669;
        }
        .tabs {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            border-bottom: 2px solid var(--color-gray-200);
            padding-bottom: var(--spacing-sm);
        }
        .tab {
            padding: 8px 16px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 500;
            color: var(--color-gray-500);
            border-bottom: 2px solid transparent;
            margin-bottom: -calc(var(--spacing-sm) + 2px);
        }
        .tab.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 500;
            z-index: 9999;
            display: none;
        }
        .toast.show { display: block; animation: slideIn 0.3s ease; }
        .toast.success { background: #10b981; }
        .toast.error { background: #ef4444; }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }
        .summary-card {
            background: var(--color-gray-50);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            text-align: center;
        }
        .summary-card .value {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: var(--color-primary);
        }
        .summary-card .label {
            font-size: var(--font-size-sm);
            color: var(--color-gray-500);
        }
    </style>
</head>
<body>
    <header class="header">
        <nav class="nav container">
            <a href="../index.html" class="logo">
                <span class="logo-text">MIAMI ALLIANCE <span class="logo-accent">3PL</span></span>
            </a>
            <ul class="nav-menu">
                <li><span id="user-name" class="nav-link" data-i18n="portal.nav.welcome">Welcome</span></li>
                <li><a href="#" id="logout-btn" class="nav-link btn btn-outline" data-i18n="portal.sidebar.logout">Logout</a></li>
            </ul>
        </nav>
    </header>

    <div class="portal-layout">
        <aside class="portal-sidebar">
            <nav>
                <a href="dashboard.html" class="portal-nav-item" data-i18n-html="portal.sidebar.dashboard"><span>üìä</span> Dashboard</a>
                <a href="shipments.html" class="portal-nav-item" data-i18n-html="portal.sidebar.shipments"><span>üöö</span> Shipments</a>
                <a href="tracking.html" class="portal-nav-item" data-i18n-html="portal.sidebar.tracking"><span>üîç</span> Tracking</a>
                <a href="inventory.html" class="portal-nav-item" data-i18n-html="portal.sidebar.inventory"><span>üì¶</span> Inventory</a>
                <div id="employee-nav" style="display: none; margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--color-gray-200);">
                    <div style="padding: 8px 16px; font-size: 0.75rem; color: var(--color-gray-500); text-transform: uppercase;" data-i18n="portal.sidebar.staffLabel">Staff</div>
                    <a href="customers.html" class="portal-nav-item" data-i18n-html="portal.sidebar.customers"><span>üë•</span> All Customers</a>
                    <a href="admin-shipments.html" class="portal-nav-item" data-i18n-html="portal.sidebar.allShipments"><span>üìã</span> All Shipments</a>
                </div>
                <div id="admin-nav" style="display: none; margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--color-gray-200);">
                    <div style="padding: 8px 16px; font-size: 0.75rem; color: var(--color-gray-500); text-transform: uppercase;" data-i18n="portal.sidebar.adminLabel">Admin</div>
                    <a href="invoices.html" class="portal-nav-item" data-i18n-html="portal.sidebar.invoices"><span>üíµ</span> Invoices</a>
                    <a href="storage-log.html" class="portal-nav-item active" data-i18n-html="portal.sidebar.storagelog"><span>üìä</span> Storage Log</a>
                    <a href="pricing.html" class="portal-nav-item" data-i18n-html="portal.sidebar.pricing"><span>üí∞</span> Pricing</a>
                    <a href="settings.html" class="portal-nav-item" data-i18n-html="portal.sidebar.settings"><span>‚öôÔ∏è</span> Settings</a>
                    <a href="team.html" class="portal-nav-item" data-i18n-html="portal.sidebar.team"><span>üëî</span> Manage Team</a>
                </div>
            </nav>
        </aside>

        <main class="portal-main">
            <div class="page-header-bar">
                <h1 data-i18n="portal.storagelog.title">üìä Storage Log</h1>
                <p data-i18n="portal.storagelog.subtitle">Record daily storage snapshots for billing</p>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="showTab('record')" data-i18n="portal.storagelog.tab.record">Record Snapshot</button>
                <button class="tab" onclick="showTab('history')" data-i18n="portal.storagelog.tab.history">History</button>
                <button class="tab" onclick="showTab('summary')" data-i18n="portal.storagelog.tab.summary">Monthly Summary</button>
            </div>

            <!-- Record Tab -->
            <div id="tab-record" class="tab-content">
                <div class="snapshot-card">
                    <h3 data-i18n="portal.storagelog.record.title">üìù Record Storage Snapshot</h3>

                    <!-- Auto-count from inventory -->
                    <div class="auto-count-banner">
                        <span>ü§ñ</span>
                        <div>
                            <strong data-i18n="portal.storagelog.autocount.label">Auto-count from Inventory:</strong>
                            <span id="auto-pallet-count" data-i18n="portal.storagelog.autocount.calculating">Calculating...</span> <span data-i18n="portal.storagelog.autocount.estimated">estimated pallets</span>
                        </div>
                        <button class="btn btn-outline" onclick="useAutoCount()" style="margin-left: auto;" data-i18n="portal.storagelog.autocount.use">Use This Count</button>
                    </div>

                    <form id="snapshot-form">
                        <div class="snapshot-form">
                            <div class="form-group">
                                <label for="snapshot-date" data-i18n="portal.storagelog.form.date">Date *</label>
                                <input type="date" id="snapshot-date" required>
                            </div>
                            <div class="form-group">
                                <label for="snapshot-customer" data-i18n="portal.storagelog.form.customer">Customer *</label>
                                <select id="snapshot-customer" required>
                                    <option value="" data-i18n="portal.storagelog.form.selectCustomer">Select customer...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="snapshot-pallets" data-i18n="portal.storagelog.form.pallets">Pallet Count *</label>
                                <input type="number" id="snapshot-pallets" min="0" required placeholder="0">
                            </div>
                            <div class="form-group">
                                <label for="snapshot-containers" data-i18n="portal.storagelog.form.containers">Container Count</label>
                                <input type="number" id="snapshot-containers" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label for="snapshot-boxes" data-i18n="portal.storagelog.form.boxes">Box/Carton Count</label>
                                <input type="number" id="snapshot-boxes" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label for="snapshot-sqft" data-i18n="portal.storagelog.form.sqft">Square Feet Used</label>
                                <input type="number" id="snapshot-sqft" min="0" step="0.1" value="0">
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: var(--spacing-md);">
                            <label for="snapshot-notes" data-i18n="portal.storagelog.form.notes">Notes</label>
                            <input type="text" id="snapshot-notes" placeholder="Optional notes..." data-i18n-placeholder="portal.storagelog.form.notesPlaceholder">
                        </div>
                        <div class="btn-row">
                            <button type="submit" class="btn btn-primary" data-i18n="portal.storagelog.form.save">Save Snapshot</button>
                            <button type="button" class="btn btn-outline" onclick="recordAllCustomers()" data-i18n="portal.storagelog.form.recordAll">Record All Customers (Auto)</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- History Tab -->
            <div id="tab-history" class="tab-content" style="display: none;">
                <div class="snapshot-card">
                    <h3 data-i18n="portal.storagelog.history.title">üìÖ Snapshot History</h3>
                    <div style="display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-md);">
                        <select id="history-customer" onchange="loadHistory()">
                            <option value="" data-i18n="portal.storagelog.history.allCustomers">All Customers</option>
                        </select>
                        <input type="month" id="history-month" onchange="loadHistory()">
                    </div>
                    <div class="table-wrapper">
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th data-i18n="portal.storagelog.table.date">Date</th>
                                    <th data-i18n="portal.storagelog.table.customer">Customer</th>
                                    <th data-i18n="portal.storagelog.table.pallets">Pallets</th>
                                    <th data-i18n="portal.storagelog.table.containers">Containers</th>
                                    <th data-i18n="portal.storagelog.table.boxes">Boxes</th>
                                    <th data-i18n="portal.storagelog.table.sqft">Sq Ft</th>
                                    <th data-i18n="portal.storagelog.table.recordedBy">Recorded By</th>
                                </tr>
                            </thead>
                            <tbody id="history-tbody">
                                <tr><td colspan="7" style="text-align: center; padding: 20px;" data-i18n="portal.storagelog.loading">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Summary Tab -->
            <div id="tab-summary" class="tab-content" style="display: none;">
                <div class="snapshot-card">
                    <h3 data-i18n="portal.storagelog.summary.title">üìà Monthly Billing Summary</h3>
                    <div style="display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-md);">
                        <select id="summary-customer" onchange="loadSummary()">
                            <option value="" data-i18n="portal.storagelog.summary.selectCustomer">Select Customer</option>
                        </select>
                        <input type="month" id="summary-month" onchange="loadSummary()">
                    </div>

                    <div class="summary-grid" id="summary-grid">
                        <div class="summary-card">
                            <div class="value" id="sum-pallet-days">0</div>
                            <div class="label" data-i18n="portal.storagelog.summary.palletDays">Pallet-Days</div>
                        </div>
                        <div class="summary-card">
                            <div class="value" id="sum-avg-pallets">0</div>
                            <div class="label" data-i18n="portal.storagelog.summary.avgPallets">Avg Pallets/Day</div>
                        </div>
                        <div class="summary-card">
                            <div class="value" id="sum-peak-pallets">0</div>
                            <div class="label" data-i18n="portal.storagelog.summary.peakPallets">Peak Pallets</div>
                        </div>
                        <div class="summary-card">
                            <div class="value" id="sum-storage-cost">$0</div>
                            <div class="label" data-i18n="portal.storagelog.summary.storageCost">Est. Storage Cost</div>
                        </div>
                    </div>

                    <div id="summary-details"></div>
                </div>
            </div>
        </main>
    </div>

    <div id="toast" class="toast"></div>

    <script src="../js/lang/es.js"></script>
    <script src="../js/i18n.js"></script>
    <script src="../js/column-prefs.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, getDoc, getDocs, addDoc, setDoc, query, where, orderBy, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyA4wMm8-QmZGt3lJcZgTpbBa1W_TklrmRg",
            authDomain: "miamialliance3pl.firebaseapp.com",
            projectId: "miamialliance3pl",
            storageBucket: "miamialliance3pl.firebasestorage.app",
            messagingSenderId: "657614666588",
            appId: "1:657614666588:web:20e50484fe5d90b5aa5f99",
            measurementId: "G-QSRV99D8BX"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const FALLBACK_ADMIN_EMAILS = ['ceo@usglatam.com', 'yuri@megalopolisms.com'];
        let customers = [];
        let inventoryByCustomer = {};
        let pricingData = {};

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = 'toast show ' + type;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Tab switching
        window.showTab = function(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tab).style.display = 'block';
            event.target.classList.add('active');

            if (tab === 'history') loadHistory();
            if (tab === 'summary') loadSummary();
        };

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = '../login.html';
                return;
            }

            // Check role
            const userDoc = await getDoc(doc(db, 'users', user.uid));
            const userData = userDoc.exists() ? userDoc.data() : {};
            const userRole = userData.role || (FALLBACK_ADMIN_EMAILS.includes(user.email.toLowerCase()) ? 'admin' : 'customer');

            if (userRole !== 'admin' && userRole !== 'employee') {
                window.location.href = 'dashboard.html';
                return;
            }

            document.getElementById('user-name').textContent = userData.name || user.email;
            document.getElementById('employee-nav').style.display = 'block';
            if (userRole === 'admin') {
                document.getElementById('admin-nav').style.display = 'block';
            }

            // Set default date to today
            document.getElementById('snapshot-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('history-month').value = new Date().toISOString().slice(0, 7);
            document.getElementById('summary-month').value = new Date().toISOString().slice(0, 7);

            await loadCustomers();
            await loadInventory();
            await loadPricing();
            calculateAutoCount();

            // Initialize column preferences for history table
            if (window.ColumnPrefs) {
                var labelFns = ColumnPrefs.firestoreLabels({ doc, getDoc, setDoc, db }, 'storage-history');
                new ColumnPrefs({
                    table: document.querySelector('.history-table'),
                    tableId: 'storage-history',
                    canRename: user.email.toLowerCase() === 'ceo@usglatam.com',
                    loadGlobalLabels: labelFns.load,
                    saveGlobalLabels: labelFns.save
                });
            }
        });

        async function loadCustomers() {
            const snap = await getDocs(collection(db, 'users'));
            customers = [];
            snap.forEach(doc => {
                const data = doc.data();
                if (!data.role || data.role === 'customer') {
                    customers.push({ id: doc.id, ...data });
                }
            });

            const selects = ['snapshot-customer', 'history-customer', 'summary-customer'];
            selects.forEach(id => {
                const select = document.getElementById(id);
                const firstOption = select.options[0];
                select.innerHTML = '';
                select.appendChild(firstOption);
                customers.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = c.company_name || c.name || c.email;
                    select.appendChild(opt);
                });
            });
        }

        async function loadInventory() {
            const snap = await getDocs(collection(db, 'inventory'));
            inventoryByCustomer = {};
            snap.forEach(doc => {
                const data = doc.data();
                const customerId = data.user_id;
                if (!inventoryByCustomer[customerId]) {
                    inventoryByCustomer[customerId] = { items: 0, quantity: 0 };
                }
                inventoryByCustomer[customerId].items++;
                inventoryByCustomer[customerId].quantity += (data.quantity || 0);
            });
        }

        async function loadPricing() {
            const pricingDoc = await getDoc(doc(db, 'settings', 'pricing'));
            pricingData = pricingDoc.exists() ? pricingDoc.data() : {};
        }

        function calculateAutoCount() {
            let totalPallets = 0;
            Object.values(inventoryByCustomer).forEach(inv => {
                // Estimate: 48 units per pallet average
                totalPallets += Math.ceil(inv.quantity / 48);
            });
            document.getElementById('auto-pallet-count').textContent = totalPallets;
        }

        window.useAutoCount = function() {
            const customerId = document.getElementById('snapshot-customer').value;
            if (!customerId) {
                showToast('Please select a customer first', 'error');
                return;
            }
            const inv = inventoryByCustomer[customerId] || { quantity: 0 };
            const pallets = Math.ceil(inv.quantity / 48);
            document.getElementById('snapshot-pallets').value = pallets;
            showToast('Auto-count applied: ' + pallets + ' pallets');
        };

        // Save snapshot
        document.getElementById('snapshot-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const customerId = document.getElementById('snapshot-customer').value;
            const customer = customers.find(c => c.id === customerId);

            const snapshot = {
                customer_id: customerId,
                customer_name: customer?.company_name || customer?.name || customer?.email || 'Unknown',
                date: document.getElementById('snapshot-date').value,
                pallet_count: parseInt(document.getElementById('snapshot-pallets').value) || 0,
                container_count: parseInt(document.getElementById('snapshot-containers').value) || 0,
                box_count: parseInt(document.getElementById('snapshot-boxes').value) || 0,
                sqft: parseFloat(document.getElementById('snapshot-sqft').value) || 0,
                notes: document.getElementById('snapshot-notes').value,
                recorded_by: auth.currentUser.uid,
                recorded_by_email: auth.currentUser.email,
                created_at: new Date().toISOString()
            };

            try {
                await addDoc(collection(db, 'storage_snapshots'), snapshot);
                showToast('Snapshot saved successfully!');
                document.getElementById('snapshot-form').reset();
                document.getElementById('snapshot-date').value = new Date().toISOString().split('T')[0];
            } catch (err) {
                showToast('Error saving: ' + err.message, 'error');
            }
        });

        // Record all customers automatically
        window.recordAllCustomers = async function() {
            const date = document.getElementById('snapshot-date').value;
            if (!date) {
                showToast('Please select a date', 'error');
                return;
            }

            let count = 0;
            for (const customer of customers) {
                const inv = inventoryByCustomer[customer.id] || { quantity: 0 };
                const pallets = Math.ceil(inv.quantity / 48);

                if (pallets > 0) {
                    await addDoc(collection(db, 'storage_snapshots'), {
                        customer_id: customer.id,
                        customer_name: customer.company_name || customer.name || customer.email,
                        date: date,
                        pallet_count: pallets,
                        container_count: 0,
                        box_count: inv.quantity,
                        sqft: 0,
                        notes: 'Auto-recorded from inventory',
                        recorded_by: 'system',
                        created_at: new Date().toISOString()
                    });
                    count++;
                }
            }
            showToast(`Recorded snapshots for ${count} customers`);
        };

        // Load history
        window.loadHistory = async function() {
            const customerId = document.getElementById('history-customer').value;
            const month = document.getElementById('history-month').value;

            let q = collection(db, 'storage_snapshots');
            const constraints = [];

            if (customerId) {
                constraints.push(where('customer_id', '==', customerId));
            }
            if (month) {
                const start = month + '-01';
                const end = month + '-31';
                constraints.push(where('date', '>=', start));
                constraints.push(where('date', '<=', end));
            }

            constraints.push(orderBy('date', 'desc'));
            q = query(q, ...constraints);

            try {
                const snap = await getDocs(q);
                const tbody = document.getElementById('history-tbody');
                tbody.innerHTML = '';

                if (snap.empty) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">No snapshots found</td></tr>';
                    return;
                }

                snap.forEach(doc => {
                    const d = doc.data();
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${d.date}</td>
                        <td>${d.customer_name || 'Unknown'}</td>
                        <td>${d.pallet_count}</td>
                        <td>${d.container_count || 0}</td>
                        <td>${d.box_count || 0}</td>
                        <td>${d.sqft || 0}</td>
                        <td>${d.recorded_by === 'system' ? 'ü§ñ Auto' : d.recorded_by_email || 'Staff'}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (err) {
                console.error(err);
                showToast('Error loading history', 'error');
            }
        };

        // Load summary
        window.loadSummary = async function() {
            const customerId = document.getElementById('summary-customer').value;
            const month = document.getElementById('summary-month').value;

            if (!customerId || !month) {
                document.getElementById('sum-pallet-days').textContent = '0';
                document.getElementById('sum-avg-pallets').textContent = '0';
                document.getElementById('sum-peak-pallets').textContent = '0';
                document.getElementById('sum-storage-cost').textContent = '$0';
                return;
            }

            const start = month + '-01';
            const end = month + '-31';

            const q = query(
                collection(db, 'storage_snapshots'),
                where('customer_id', '==', customerId),
                where('date', '>=', start),
                where('date', '<=', end),
                orderBy('date', 'asc')
            );

            try {
                const snap = await getDocs(q);
                let totalPalletDays = 0;
                let peakPallets = 0;
                let days = 0;

                snap.forEach(doc => {
                    const d = doc.data();
                    totalPalletDays += d.pallet_count;
                    if (d.pallet_count > peakPallets) peakPallets = d.pallet_count;
                    days++;
                });

                const avgPallets = days > 0 ? (totalPalletDays / days).toFixed(1) : 0;
                const dailyRate = pricingData?.storage?.palletDaily || 0;
                const storageCost = (totalPalletDays * dailyRate).toFixed(2);

                document.getElementById('sum-pallet-days').textContent = totalPalletDays;
                document.getElementById('sum-avg-pallets').textContent = avgPallets;
                document.getElementById('sum-peak-pallets').textContent = peakPallets;
                document.getElementById('sum-storage-cost').textContent = '$' + storageCost;

                document.getElementById('summary-details').innerHTML = `
                    <p style="margin-top: var(--spacing-md); color: var(--color-gray-600);">
                        <strong>${days}</strong> days recorded &bull;
                        Daily rate: <strong>$${dailyRate.toFixed(2)}</strong>/pallet &bull;
                        ${totalPalletDays} pallet-days √ó $${dailyRate.toFixed(2)} = <strong>$${storageCost}</strong>
                    </p>
                `;
            } catch (err) {
                console.error(err);
                showToast('Error loading summary', 'error');
            }
        };

        document.getElementById('logout-btn').addEventListener('click', async () => {
            await signOut(auth);
            window.location.href = '../login.html';
        });
    </script>
</body>
</html>
