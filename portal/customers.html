<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customers | Miami Alliance 3PL Admin</title>
    <meta name="robots" content="noindex, nofollow">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì¶</text></svg>">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="../css/style.css?v=202602230300">
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QSRV99D8BX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-QSRV99D8BX');
    </script>
    <script src="../js/analytics.js"></script>
    <style>
        .admin-badge {
            background: linear-gradient(135deg, #f97316, #ea580c);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }
        .page-header-bar {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            color: white;
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-xl);
        }
        .page-header-bar h1 {
            font-size: var(--font-size-2xl);
            margin-bottom: var(--spacing-xs);
        }
        .search-bar {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
        }
        .search-bar input {
            flex: 1;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--color-gray-300);
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
        }
        .customer-card {
            background: white;
            border: 1px solid var(--color-gray-200);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            transition: box-shadow 0.2s;
        }
        .customer-card:hover {
            box-shadow: var(--shadow-lg);
        }
        .customer-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-sm);
        }
        .customer-name {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--color-gray-900);
        }
        .customer-company {
            color: var(--color-accent);
            font-weight: 500;
        }
        .customer-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-sm);
            color: var(--color-gray-600);
            font-size: var(--font-size-sm);
        }
        .customer-meta span {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .customer-stats {
            display: flex;
            gap: var(--spacing-md);
            margin-top: var(--spacing-md);
            padding-top: var(--spacing-md);
            border-top: 1px solid var(--color-gray-200);
        }
        .stat-item {
            text-align: center;
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--color-gray-100);
            border-radius: var(--radius-md);
        }
        .stat-item .value {
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: var(--color-primary);
        }
        .stat-item .label {
            font-size: var(--font-size-xs);
            color: var(--color-gray-500);
        }
        .empty-state {
            text-align: center;
            padding: var(--spacing-2xl);
            color: var(--color-gray-500);
        }
        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: var(--spacing-md);
        }
        /* Edit button styles */
        .btn-edit {
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: var(--font-size-sm);
            font-weight: 500;
            transition: background 0.2s;
        }
        .btn-edit:hover {
            background: var(--color-primary-dark);
        }
        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--color-gray-200);
        }
        .modal-header h2 {
            font-size: var(--font-size-xl);
            color: var(--color-gray-900);
            margin: 0;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--color-gray-500);
            padding: 0;
            line-height: 1;
        }
        .modal-close:hover {
            color: var(--color-gray-900);
        }
        .form-group {
            margin-bottom: var(--spacing-md);
        }
        .form-group label {
            display: block;
            font-weight: 500;
            color: var(--color-gray-700);
            margin-bottom: var(--spacing-xs);
        }
        .form-group input {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--color-gray-300);
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            box-sizing: border-box;
        }
        .form-group input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(30, 58, 95, 0.1);
        }
        .form-group .readonly-value {
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--color-gray-100);
            border-radius: var(--radius-md);
            color: var(--color-gray-600);
            font-size: var(--font-size-base);
        }
        .modal-actions {
            display: flex;
            gap: var(--spacing-sm);
            justify-content: flex-end;
            margin-top: var(--spacing-lg);
            padding-top: var(--spacing-md);
            border-top: 1px solid var(--color-gray-200);
        }
        .btn-cancel {
            background: var(--color-gray-200);
            color: var(--color-gray-700);
            border: none;
            padding: 10px 20px;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 500;
        }
        .btn-cancel:hover {
            background: var(--color-gray-300);
        }
        .btn-save {
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 500;
        }
        .btn-save:hover {
            background: var(--color-primary-dark);
        }
        .btn-save:disabled {
            background: var(--color-gray-400);
            cursor: not-allowed;
        }
        /* Toast styles */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            padding: 12px 20px;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 500;
            box-shadow: var(--shadow-lg);
            animation: slideIn 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .toast.success {
            background: #10b981;
        }
        .toast.error {
            background: #ef4444;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <header class="header">
        <nav class="nav container">
            <a href="../index.html" class="logo">
                <span class="logo-text">MIAMI ALLIANCE <span class="logo-accent">3PL</span></span>
            </a>
            <button class="nav-toggle sidebar-toggle" aria-label="Toggle sidebar">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <ul class="nav-menu">
                <li><span id="user-name" class="nav-link">Welcome</span></li>
                <li><a href="#" id="logout-btn" class="nav-link btn btn-outline">Logout</a></li>
            </ul>
        </nav>
    </header>

    <div class="portal-layout">
        <!-- Sidebar -->
        <aside class="portal-sidebar">
            <nav>
                <a href="dashboard.html" class="portal-nav-item">
                    <span>üìä</span> Dashboard
                </a>
                <a href="shipments.html" class="portal-nav-item">
                    <span>üöö</span> Shipments
                </a>
                <a href="tracking.html" class="portal-nav-item">
                    <span>üîç</span> Tracking
                </a>
                <a href="inventory.html" class="portal-nav-item">
                    <span>üì¶</span> Inventory
                </a>
                <div id="admin-nav" style="display: none; margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--color-gray-200);">
                    <div style="padding: 8px 16px; font-size: 0.75rem; color: var(--color-gray-500); text-transform: uppercase;">Admin</div>
                    <a href="pricing.html" class="portal-nav-item">
                        <span>üí∞</span> Pricing
                    </a>
                    <a href="settings.html" class="portal-nav-item">
                        <span>‚öôÔ∏è</span> Settings
                    </a>
                    <a href="team.html" class="portal-nav-item">
                        <span>üëî</span> Manage Team
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="portal-main">
            <!-- Page Header -->
            <div class="page-header-bar">
                <h1 id="page-title">üë• All Customers</h1>
                <p>Manage and view all registered customers</p>
            </div>

            <!-- Search Bar -->
            <div class="search-bar">
                <input type="text" id="search-input" placeholder="Search by name, email, or company...">
                <button class="btn btn-primary" onclick="searchCustomers()">Search</button>
            </div>

            <!-- Stats Summary -->
            <div class="dashboard-stats" style="margin-bottom: var(--spacing-xl);">
                <div class="dashboard-card">
                    <h3>Total Customers</h3>
                    <div class="value" id="total-customers">0</div>
                </div>
                <div class="dashboard-card">
                    <h3>New This Month</h3>
                    <div class="value" id="new-customers">0</div>
                </div>
                <div class="dashboard-card">
                    <h3>Active Shippers</h3>
                    <div class="value" id="active-customers">0</div>
                </div>
            </div>

            <!-- Customers List -->
            <div id="customers-list">
                <div class="empty-state">
                    <div class="icon">‚è≥</div>
                    <p>Loading customers...</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Edit Customer Modal -->
    <div class="modal-overlay" id="edit-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Edit Customer</h2>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <form id="edit-customer-form">
                <input type="hidden" id="edit-customer-id">
                <div class="form-group">
                    <label for="edit-name">Name</label>
                    <input type="text" id="edit-name" required>
                </div>
                <div class="form-group">
                    <label for="edit-company">Company Name</label>
                    <input type="text" id="edit-company">
                </div>
                <div class="form-group">
                    <label for="edit-email">Email</label>
                    <input type="email" id="edit-email" required>
                </div>
                <div class="form-group">
                    <label for="edit-phone">Phone</label>
                    <input type="tel" id="edit-phone">
                </div>
                <div class="form-group">
                    <label>Total Shipments</label>
                    <div class="readonly-value" id="edit-shipments-count">0</div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="btn-save" id="save-btn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, where, orderBy, getDocs, doc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA4wMm8-QmZGt3lJcZgTpbBa1W_TklrmRg",
            authDomain: "miamialliance3pl.firebaseapp.com",
            projectId: "miamialliance3pl",
            storageBucket: "miamialliance3pl.firebasestorage.app",
            messagingSenderId: "657614666588",
            appId: "1:657614666588:web:20e50484fe5d90b5aa5f99",
            measurementId: "G-QSRV99D8BX"
        };

        // Fallback admin emails (used only if no Firestore role exists)
        const FALLBACK_ADMIN_EMAILS = ['ceo@usglatam.com', 'yuri@megalopolisms.com'];

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allCustomers = [];

        // Check authentication and role
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = '../login.html';
                return;
            }

            let userName = user.displayName || user.email;
            const userEmail = user.email.toLowerCase();

            // Check user role from Firestore users collection
            let userRole = null;
            try {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists()) {
                    userRole = userDoc.data().role;
                }
            } catch (error) {
                console.error('Error fetching user role:', error);
            }

            // Determine if user is staff (admin or employee)
            let isAdmin = false;
            let isEmployee = false;

            if (userRole) {
                // Use Firestore role
                isAdmin = userRole === 'admin';
                isEmployee = userRole === 'employee';
            } else {
                // Fallback: check admin emails if no Firestore role exists
                isAdmin = FALLBACK_ADMIN_EMAILS.map(e => e.toLowerCase()).includes(userEmail);
            }

            // Only allow admin or employee roles to access this page
            if (!isAdmin && !isEmployee) {
                window.location.href = 'dashboard.html';
                return;
            }

            const userNameEl = document.getElementById('user-name');
            if (isAdmin) {
                userNameEl.innerHTML = `${userName} <span class="admin-badge">ADMIN</span>`;
            } else if (isEmployee) {
                userNameEl.innerHTML = `${userName} <span class="admin-badge">EMPLOYEE</span>`;
            }

            loadCustomers();
        });

        // Logout handler
        document.getElementById('logout-btn').addEventListener('click', async (e) => {
            e.preventDefault();
            await signOut(auth);
            window.location.href = '../login.html';
        });

        async function loadCustomers() {
            try {
                const customersRef = collection(db, 'users');
                const customersSnap = await getDocs(customersRef);

                allCustomers = [];
                let newThisMonth = 0;
                const now = new Date();
                const firstOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

                customersSnap.forEach((doc) => {
                    const data = { id: doc.id, ...doc.data() };
                    allCustomers.push(data);

                    // Check if new this month
                    if (data.created_at) {
                        const createdDate = new Date(data.created_at);
                        if (createdDate >= firstOfMonth) {
                            newThisMonth++;
                        }
                    }
                });

                // Update stats
                document.getElementById('total-customers').textContent = allCustomers.length;
                document.getElementById('new-customers').textContent = newThisMonth;

                // Count active shippers (have at least 1 shipment)
                const shipmentsSnap = await getDocs(collection(db, 'shipments'));
                const activeUserIds = new Set();
                shipmentsSnap.forEach((doc) => {
                    const data = doc.data();
                    if (data.user_id) activeUserIds.add(data.user_id);
                });
                document.getElementById('active-customers').textContent = activeUserIds.size;

                // Display customers
                displayCustomers(allCustomers);

            } catch (error) {
                console.error('Error loading customers:', error);
                document.getElementById('customers-list').innerHTML = `
                    <div class="empty-state">
                        <div class="icon">‚ùå</div>
                        <p>Error loading customers: ${error.message}</p>
                    </div>
                `;
            }
        }

        async function displayCustomers(customers) {
            const container = document.getElementById('customers-list');

            if (customers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üë•</div>
                        <p>No customers found</p>
                    </div>
                `;
                return;
            }

            // Get shipment counts per user
            const shipmentsSnap = await getDocs(collection(db, 'shipments'));
            const shipmentCounts = {};
            shipmentsSnap.forEach((doc) => {
                const data = doc.data();
                if (data.user_id) {
                    shipmentCounts[data.user_id] = (shipmentCounts[data.user_id] || 0) + 1;
                }
            });

            // Sort by created_at descending
            customers.sort((a, b) => {
                const dateA = a.created_at ? new Date(a.created_at) : new Date(0);
                const dateB = b.created_at ? new Date(b.created_at) : new Date(0);
                return dateB - dateA;
            });

            // Store shipment counts globally for modal access
            window.customerShipmentCounts = shipmentCounts;

            container.innerHTML = customers.map(customer => `
                <div class="customer-card">
                    <div class="customer-header">
                        <div>
                            <div class="customer-name">${customer.name || 'Unknown'}</div>
                            <div class="customer-company">${customer.company_name || 'No company'}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <button class="btn-edit" onclick="openEditModal('${customer.id}')">Edit</button>
                            <span class="badge ${customer.isAdmin ? 'badge-pending' : 'badge-delivered'}">${customer.isAdmin ? 'Admin' : 'Customer'}</span>
                        </div>
                    </div>
                    <div class="customer-meta">
                        <span>üìß ${customer.email || 'No email'}</span>
                        <span>üìû ${customer.phone || 'No phone'}</span>
                        <span>üìÖ Joined: ${customer.created_at ? new Date(customer.created_at).toLocaleDateString() : 'Unknown'}</span>
                    </div>
                    <div class="customer-stats">
                        <div class="stat-item">
                            <div class="value">${shipmentCounts[customer.id] || 0}</div>
                            <div class="label">Shipments</div>
                        </div>
                        <div class="stat-item">
                            <div class="value">${customer.id.substring(0, 8)}...</div>
                            <div class="label">User ID</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Search functionality
        window.searchCustomers = function() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const filtered = allCustomers.filter(c =>
                (c.name && c.name.toLowerCase().includes(searchTerm)) ||
                (c.email && c.email.toLowerCase().includes(searchTerm)) ||
                (c.company_name && c.company_name.toLowerCase().includes(searchTerm))
            );
            displayCustomers(filtered);
        };

        // Search on Enter key
        document.getElementById('search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchCustomers();
        });

        // Toast notification function
        window.showToast = function(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${type === 'success' ? '‚úì' : '‚úï'}</span> ${message}`;
            container.appendChild(toast);

            // Auto-remove after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        };

        // Open edit modal
        window.openEditModal = function(customerId) {
            const customer = allCustomers.find(c => c.id === customerId);
            if (!customer) {
                showToast('Customer not found', 'error');
                return;
            }

            // Populate form fields
            document.getElementById('edit-customer-id').value = customer.id;
            document.getElementById('edit-name').value = customer.name || '';
            document.getElementById('edit-company').value = customer.company_name || '';
            document.getElementById('edit-email').value = customer.email || '';
            document.getElementById('edit-phone').value = customer.phone || '';
            document.getElementById('edit-shipments-count').textContent = window.customerShipmentCounts[customer.id] || 0;

            // Show modal
            document.getElementById('edit-modal').classList.add('active');
        };

        // Close edit modal
        window.closeEditModal = function() {
            document.getElementById('edit-modal').classList.remove('active');
            document.getElementById('edit-customer-form').reset();
        };

        // Close modal on overlay click
        document.getElementById('edit-modal').addEventListener('click', (e) => {
            if (e.target.id === 'edit-modal') {
                closeEditModal();
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeEditModal();
            }
        });

        // Handle form submission
        document.getElementById('edit-customer-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const saveBtn = document.getElementById('save-btn');
            const customerId = document.getElementById('edit-customer-id').value;

            if (!customerId) {
                showToast('No customer selected', 'error');
                return;
            }

            // Disable save button
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            try {
                const customerRef = doc(db, 'users', customerId);
                await updateDoc(customerRef, {
                    name: document.getElementById('edit-name').value.trim(),
                    company_name: document.getElementById('edit-company').value.trim(),
                    email: document.getElementById('edit-email').value.trim(),
                    phone: document.getElementById('edit-phone').value.trim(),
                    updated_at: new Date().toISOString()
                });

                showToast('Customer updated successfully!', 'success');
                closeEditModal();

                // Reload customers to reflect changes
                loadCustomers();

            } catch (error) {
                console.error('Error updating customer:', error);
                showToast('Failed to update customer: ' + error.message, 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Changes';
            }
        });
    </script>
    <script src="../js/main.js"></script>
</body>
</html>
